let e="p-l",t="p-r",r="p-w",i="p-b",l="pd-l",s="pd-r",a="f-l",o="f-r",n="pd-w",m=m=>{let f,d=m.getPlayer(),c=m.getAdjItem([d.x,d.y]);if("sw"===d.itemLeft?.name)return f=m.getAdjTile([d.x,d.y],[v]),f?{type:n}:{type:"sw"};if("buck"===d.itemLeft?.name)return f=m.getAdjTile([d.x,d.y],[T]),f?{type:i}:{type:"d-b"};if(f=m.getAdjTile([d.x,d.y],[A]))return{type:"r",tile:f};if(!(!c||d.itemLeft&&d.itemRight)){let[r,,[i,l]]=c;if("mugF"===c[0].name)for(let[e,t]of Ae([i,l])){let r=m.getPatronAt(e,t);if("wfd"===r?.getState())return}return{type:d.itemLeft?t:e,item:r}}return d.itemLeft||d.itemRight||!(f=m.getAdjTile([d.x,d.y],[v]))?d.itemLeft||d.itemRight||!(f=m.getAdjTile([d.x,d.y],[T]))?"mugE"===d.itemLeft?.name&&m.getAdjTile([d.x,d.y],h)?{type:a,item:d.itemLeft}:"mugE"===d.itemRight?.name&&m.getAdjTile([d.x,d.y],h)?{type:o,item:d.itemRight}:d.itemRight&&!["sword"].includes(d.itemRight.name)&&(f=m.getAdjTile([d.x,d.y],u))&&!m.getItemAt(f[1],f[2])?{type:s,tile:f,item:d.itemRight}:d.itemLeft&&!["sword"].includes(d.itemLeft.name)&&(f=m.getAdjTile([d.x,d.y],u))&&!m.getItemAt(f[1],f[2])?{type:l,tile:f,item:d.itemLeft}:void 0:{type:i,tile:f}:{type:r,tile:f}},f=()=>{let e={x:0,y:0,scale:1,vx:0,vy:0,remv:!1,getPos:()=>[e.x,e.y],update:()=>{},draw:()=>{}};return e},d={},c={},g=e=>{let t=d[e];if(!t)throw Error("No anim: "+e);let[,r,...i]=t.split(" "),l=parseInt(r);return function([e,t,r]){let i,l,s,a,o=e||!1,n=[];n=[],i=!1,l=0,s=0,a=0,r.forEach((({n:e,d:t,offsetX:r,offsetY:i,opacity:s})=>{n.push({n:e||"",timestampBegin:l,timestampEnd:l+(t??0),d:t??0,durationUpToNow:l,offsetX:r||0,offsetY:i||0,opacity:s}),l+=t??0}));let m={reset(){i=!1,s=0,m.start()},start(){a=ce()},update(){let e=ce();if(s===n.length-1&&o&&e-a>l){let t=a+l;m.reset(),m.start(),e-t<l&&(a=t)}s=(e=>{let t=0,r=s,i=n.length-1;for(;r<=i;){let l=r+Math.floor((i-r)/2);t=l;let{timestampEnd:s,timestampBegin:o}=n[l],m=(s||0)+a;if(e<m&&e>(o||0)+a)return l;e>=m?r=l+1:i=l-1}return t})(e),o||e-a>=l&&(i=!0)},getSprite:()=>n[s]?.n};return m}([!0,e,i.map((e=>({n:e,d:l})))])},p=[12,14,27,28,29,39],u=[19,20,21,22],h=[18],w=20,y=19,v=13,T=24,A=14,x=["",'"Hey, barkeep!\nFill a mug and set it down\nhere in front of me."',"Looks like it's busy today.\nPatrons are overflowing to the side room.","In Case of Fire:\nFETCH BUCKET OF WATER\nFROM WELL OUTSIDE","We need more tables!\nOpen up the other side room!","We're attracting moles now!\nGrab a weapon when you see 'em!\nThat's why we have a weapons rack!","Business is booming!\nWe have a whole new taproom now!","A bigger tavern always\nattracts more moles.","We need to expand again!\nTheres even more space\nin the back.","A bouncer would be nice\nto remove of all these moles!","We can squeeze a few more\n in the private taproom."],b=[4,2,6,5,1,3],L=e=>b.indexOf(e)+1,_=e=>p.includes(e),k=e=>26===e,P={font:"monospace",color:"#fff",size:14,align:"center",strokeColor:"black"},E=1,M=e=>{E=e},S=(e,t,r,i,l)=>{i=i||1,l=l||W();let s="string"==typeof e?$(e):e;if(!s)throw Error(`No sprite: "${e}"`);let[a,o,n,m,f]=s;l.drawImage(a,o,n,m,f,t,r,m*i,f*i)},C=(e,t,r,i,l,s,a)=>{(a=a||W())[s?"strokeStyle":"fillStyle"]=l,a[s?"strokeRect":"fillRect"](e,t,r,i)},O=(e,t,r,i,l)=>{let{font:s,size:a,color:o,align:n,strokeColor:m}={...P,...i||{}};(l=l||W()).font=`${a}px ${s}`,l.textAlign=n,l.textBaseline="middle",m&&(l.strokeStyle=m,l.lineWidth=4,l.strokeText(e,t,r)),l.fillStyle=o,l.fillText(e,t,r)},D=null,R=null,j=null,I=e=>{let[t,r,i]=F(e.width,e.height);return r.translate(i,0),r.scale(-1,1),r.drawImage(e,0,0),t},z=e=>{let[,,,t,r]=e,[i,l]=F(t,r);return S(e,0,0,1,l),i},F=(e,t)=>{let r=document.createElement("canvas");r.width=e,r.height=t;let i=r.getContext("2d");return i.imageSmoothingEnabled=!1,[r,i,e,t]},B=()=>{if(D)return D;{let[e,t]=F(576,576);return e.id="canv",t.lineWidth=2,window.canvasDiv.appendChild(e),D=e,e}},W=()=>B().getContext("2d"),$=e=>j[e],N=(e,[t,r,i])=>_(pe(e,t,i))&&-1===pe(e,r,i),H=(e,t)=>{let r=[];for(let i=0;i<e**2;i++)r.push(t);return r},U=(e,t,r)=>{let[i,l]=e,[,s,a]=t;N(e,t)&&(s[i+l*a]=r,Ae([i,l]).forEach((e=>{U(e,t,r)})))},V=(e,t)=>{let r=t[1]||[],i=t[2];if(0===r.length)for(let e=0;e<i**2;e++)r.push(-1);for(let r=0;r<i**2;r++){let l=[r%i,Math.floor(r/i)];if(N(l,t))return U(l,t,e),!0}return!1},q=(e,t,r,i)=>{let l=H(r,0),s=(i,l,a,o=!0)=>{var n;-1===pe(i,e,r)&&(a.push([i[0]+i[1]*r,l]),o&&(n=t[i[0]+i[1]*r],[13,17,18,18,20,21,22].concat(p).includes(n))&&Ae(i,!0).forEach((e=>{s(e,l,a,!1)})))},a=[];for(let t=0;t<r;t++)for(let o=0;o<r;o++){let n=t*r+o;e[n]===i&&(l[n]=i,Ae([o,t],!0).forEach((e=>{s(e,i,a)})))}for(let[e,t]of a)l[e]=t;return l},Y=(e,t)=>{let r=1,i=H(t,-1),l=[e,i,t];for(;V(r,l);)r++;let s=[];for(let l=1;l<r;l++)s.push(q(i,e,t,l));return s},G=()=>window.game;window.addEventListener("load",(()=>{X()}));let X=async()=>{K()},K=async()=>{await(async e=>{B();let t={},r={};await Promise.all([["sprite","res/sprite.png",16,16]].map((([e,i,l,s],a)=>new Promise((a=>{let o=new Image;o.onload=()=>{t[e]=o,((e,t,r,i,l)=>{let s=(t,r,i,l,s,a)=>{let[o,n]=F(s,a);return n.drawImage(r,i,l,s,a,0,0,s,a),e[t]=[o,0,0,s,a]},a=t.width/i,o=t.height/l;for(let e=0;e<o;e++)for(let r=0;r<a;r++){let o="s_"+(e*a+r),n=s(o,t,r*i,e*l,i,l);s(o+"_f",I(z(n)),0,0,i,l)}})(r,o,0,l,s),a()},o.src=i}))))),R=t,j=r})();let f=await(await fetch("res/map.json")).json();(()=>{let e=(e,t)=>{d[e]=t},t=[["mole",["s_9","s_10"]],["p_walk",["s_3"]],["p_wait",["s_3","s_4"]],["p2_wait",["s_5","s_6"]],["p_angry",["s_7","s_8"]],["part_+1",["s_39"]],["water",["s_40"]],["bloodf",["s_36"]],["blood",["s_35"]]];for(let[r,i]of t)e(r+"_l","t 300 "+i.join(" ")),e(r+"_r","t 300 "+i.map((e=>e+"_f")).join(" "));e("fire","t 150 s_14 s_15")})(),c.item=[,0,976,,,0,2,.15,-.4,,-547,.01,,,9.8,.1,,,.06,.03],c.itemPlace=[,0,104,,.15,.03,2,.38,,-61,,,.15,,,,,,.02,.36],c.doorOpen=[1.75,,151,.03,.01,.19,2,1.33,-9,,,,,.1,,,,.19,.01],c.doorClose=[1.24,,339,.12,.05,0,1,.42,-24,.1,,,.08,,-19,.6,,,,.79],c.fill=[1.09,,0,.19,,.02,,2.31,92,-25,927,,,,-1.4,.9,,.5,.09],c.moleDead=[2.1,,1360,.06,.09,.2,2,1.63,,,,,,.9,-.4,.1,.03,.57,,.01],c.moleAlert=[,,169,,.13,,2,2.18,.1,-7,,,.11,.6,,,,,.18,.05],c.plusOne=[1.12,,73,.02,.18,.06,2,.87,,,-190,.11,,,,,,.82,.01,.29],c.drawSword=[,,455,,.09,.01,2,2.31,,,-758,.01,.02,,,,,,.2,.59],c.swingSword=[,,232,.07,.02,0,4,.27,29,75,,,,.1,,,,,,.02],c.patronAngry=[1.29,,322,.03,.17,0,,.55,,-89,-843,.15,.09,.3,-234,,.02,,.09],c.dumpBucket=[1.99,,246,,.07,.03,4,.66,47,32,,,,,-.4,,.25,,.13,.83],c.hitSomething=[1.04,,772,,.07,.06,2,.31,90,-15,590,.02,,,,.3,,.47,.03],c.personHit=[,,495,.05,.19,0,3,.15,.1,,,,,,.4,,,,.03,.02],c.fire=[1.06,,1028,.11,.14,.03,4,.15,-4.8,,-690,.18,,.1,,.4,.07,.99,.15],c.destroyCrate=[,,80,.04,.03,.2,4,.34,-.3,,,,,,-9.9,,,,.18],c.levelDone=[1.04,,3,.06,.09,.09,1,.84,,14,,,,,5.2,,,.43,.13],c.levelScreen=[1.85,,123,.15,.15,.01,2,1.15,,-54,,,.26,,.3,,.06,.7,.03,.04],c.startLevel=[1.05,,0,.01,.17,.17,1,1.56,,73,225,.01,.09,,-.1,,,.43],c.gameOver=[1.7,,146,.22,.07,.18,4,2.48,,82,,,,,253,,.21,,,.01],c.timerTick=[,,1091,.18,.02,.17,4,.91,,-42,,,,,167,,,,.02];let g=+localStorage.getItem("js13k2023_tavernity_width");!isNaN(g)&&g>0&&(B().style.width=g+"px"),J(function(f,d,c){let g=ne(f,d,c),p=fe(),u=te(),h=new he(1e3),v=new he(3e3),T=!1,A=!1,b="",L=0,_=0,k=document.getElementById("key-info").children[0],P="",E=window.player=oe(),M=!0,D=!1,R=!1,j=!1;new he(2e3),window.addEventListener("keydown",(e=>{" "===e.key&&setTimeout((()=>{M?(ve("itemPlace"),z(),$()):D?(ve("itemPlace"),F()):R?(ve("startLevel"),N()):j&&(ve("itemPlace"),H())}),1)}));let I=()=>Y.patrons.reduce(((e,t)=>["wfd","f","r"].includes(t.getState())?e+1:e),0),z=()=>{Y.setup(),M=!1},F=()=>{D=!1,T=!1,u.incLevel(),$()},$=()=>{q(),Y.update(1),b=x[Y.levelOrch.getTotalLevel()]??"And they just keep coming...",R=!0},N=()=>{q(),R=!1,T=!1},H=()=>{j=!1,M=!0,Y.setup()},U=e=>{for(let t=0;t<e.length;t++){let r=e[t];r.update(),r.remv&&(e.splice(t,1),t--)}},V=e=>{for(let t=0;t<e.length;t++){let r=e[t];Y.room.isTileVisible(r.x,r.y)&&r.draw()}},q=()=>{Y.patrons=[],Y.particles=[],Y.fParticles=[],Y.tileOrch=de(g,u.level);let e=u.getTotalLevel();if(0===Y.items.length)for(let[e,t]of[[5,11],[5,12],[8,10],[4,15],[21,9],[21,10],[17,13],[15,3],[21,3]])Y.items.push(ee("mugE",e,t));1===e&&Y.patrons.push(se("person",11,14)),E.x=10,E.y=12,p.start(u.level,e),Y.room&&Y.room.reset(u.level),E.reset(),L=0},Y={cx:0,cy:0,scale:4,room:g,tileOrch:de(g,1),levelOrch:u,items:[],patrons:[],particles:[],fParticles:[],setup(){u.reset(),Y.items=[],q(),E.itemLeft=void 0,E.itemRight=void 0,T=!1},isPaused:()=>M||D||R||j,setAdjTableOnFire(e){let t=Y.getAdjTile(e,[y,w]);if(t&&15!==t[0]){let[,e,r]=t;Y.room.setTileAt(e,r,15);let i=Y.getItemAt(e,r);ve("fire"),i&&"mugF"===i.name&&(i.name="mugE")}},getPlayer:()=>E,getItemAt:(e,t)=>Y.items.find((r=>r.x===e&&r.y===t)),getPatronAt:(e,t)=>Y.patrons.find((r=>r.x===e&&r.y===t)),getAdjTile([e,t],r){for(let i of r)for(let[r,l]of Ae([e,t]).concat([[e,t]])){let e=Y.room.getTileAt(r,l);if(e&&e[0]===i)return e}},getAdjItem([e,t]){let r,i,l=0,s=Ae([e,t]).concat([[e,t]]);for(let e of Y.items)for(let[t,a]of s)e.x===t&&e.y===a&&(r&&r.name!==e.name||(l++,r=e,i=[t,a]));if(r&&i)return[r,l,i]},update(e){if(Y.isPaused())return;p.update(),g.update(),U(Y.patrons),E.update(),U(Y.particles),U(Y.fParticles),U(Y.items);let t=B();Y.cx=16*E.x*Y.scale-t.width/2+8*Y.scale,Y.cy=16*E.y*Y.scale-t.height/2+8*Y.scale,u.isLevelComplete(Y,p)&&!D&&(T?v.isDone()&&(T=!1,D||(k.style.opacity="0",D=!0,E.x=0,E.y=0,ve("levelScreen"),u.addCrateBonus())):(ve("levelDone"),T=!0,v.start())),I()>0&&p.lvlTimer.isDone()&&(ve("gameOver"),j=!0,k.style.opacity="0",_=u.getScore()[2])},draw(){let f=W();if(M)return void(()=>{h.isDone()&&(A=!A,h.start());let e=W(),{width:t,height:r}=e.canvas,i=Y.scale;C(0,0,t,r,"#000");let l=(e,t,r)=>{for(let i=0;i<9;i++)r?S("s_24",e,16*i*t,t):S("s_24",16*i*t,e,t)};l(0,i),l(r-16*i,i),l(0,Y.scale,!0),l(t-16*i,i,!0),k.style.opacity="0";for(let e=0;e<7;e++)for(let t=0;t<7;t++)S("s_11",16*i+16*t*i,16*i+16*e*i,i);S("s_17",t/2-16*i/2,r/2-16*i/2,i),S("s_18",t/2-16*i/2-16*i,r/2-16*i/2,i),S(A?"s_29":"s_30",t/2-16*i/2-16*i,r/2-16*i/2,i),S("s_18",t/2-16*i/2+16*i,r/2-16*i/2,i),S(A?"s_30":"s_29",t/2-16*i/2+16*i,r/2-16*i/2,i),O("TAVERNITY",t/2,r/2-32*i,{size:42,align:"center"}),O('"Serve me quick, barkeep,\nbefore I get angry."',t/2,r/2-16*i,{size:16,align:"center"}),O("Last Score: "+_,t/2,r/2+16*i,{size:24,align:"center"}),O("Press (SPACE) to continue.",t/2,r/2+32*i+16,{size:24,align:"center"})})();if(D)return void(()=>{let e=W(),{width:t,height:r}=e.canvas,i=Y.scale;C(0,0,t,r,"#000");let[l,s,a]=u.getScore(),o={size:24,align:"center"};O(`Level ${u.getTotalLevel()} Complete`,t/2,r/2-32*i,{size:42,align:"center"}),O("Round Score: "+l,t/2,r/2+12*i,{size:24,align:"center"}),O("Crate Bonus: "+s,t/2,r/2+24*i,o),O("Total Score: "+a,t/2,r/2+36*i,o),O("Press (SPACE) to start",t/2,r/2+48*i+16,o)})();if(j)return void(()=>{let e=W(),{width:t,height:r}=e.canvas,[,,i]=u.getScore(),l=Y.scale;C(0,0,t,r,"#000"),O("GAME OVER",t/2,r/2-32*l,{size:42,align:"center"}),O("Total Score: "+i,t/2,r/2+36*l,{size:24,align:"center"}),O("Press (SPACE) to start",t/2,r/2+48*l+16,{size:24,align:"center"})})();f.save(),f.translate(-Y.cx,-Y.cy),f.scale(Y.scale,Y.scale),Y.room.draw(),V(Y.fParticles),V(Y.items),V(Y.patrons),E.draw(),V(Y.particles);let d=m(Y);if(d){let{type:m,item:f}=d,c="",g="(SPACE)";switch(m){case e:case t:c=`Pick up ${Q(f.name)} ${g}`;break;case r:c="Pick up Sword "+g;break;case i:c="Pick up Water Bucket "+g;break;case l:case s:c=`Place ${Q(f.name)} ${g}`;break;case a:case o:c="Fill Mug "+g;break;case n:c="Put away Sword "+g;break;case"r":c="Repair "+g}P===c&&""!==P||(k.style.opacity=""===c?"0":"1",k.innerHTML=c,P=c)}else k.style.opacity="0",P="";f.restore(),(()=>{let e=W(),{width:t,height:r}=e.canvas,i=I();if(O(""+(p.getRemaining()+i),64,32,{size:24,align:"left"}),C(4,4,48,52,"rgba(255, 255, 255, 0.5)"),S("s_3",4,4,3),O("Level: "+u.getTotalLevel(),16,r-16,{size:24,align:"left"}),T)O("Level ending soon...",t/2,128,{size:24,align:"center"});else if(!(R||p.isDone()&&0===i)){let e=Math.floor((1-p.lvlTimer.pct())*p.getMaxTime()/1e3);O("Time: "+Math.floor(e),t-(e<=10?16:24),16,{size:e<=10?32:24,align:"right"}),L!==e&&(L=e,e<=10&&ve("timerTick"))}})(),R&&(()=>{let e=b.split("\n"),t=e.length,r=W(),{width:i,height:l}=r.canvas,s=Y.scale,a=1===t?0:-(12*s+16*t)/2;C(0,l/2+a-16,i,12*t*s+16,"#000");for(let r=0;r<t;r++)O(e[r],i/2,l/2+12*r*s+16+a,{size:24,align:"center"})})()}};return window.game=Y,Y.setup(),Y}(f.tiles,f.width,f.spawns))},J=e=>{let t=performance.now(),r=ge(22,16,30,1,2),i=()=>{(()=>{let e=B();C(0,0,e.width,e.height,"grey")})(),e.draw(),requestAnimationFrame(i)};setInterval((()=>{let i=performance.now(),l=i-t;t=i,l>4&&(l=4);let s=l;l-=s;let a=s*r/10;M(a),e.update(a)}),22),i()};window.vol=e=>{xe(.3*+e.value/100)};let Q=e=>({mugE:"Mug",mugF:"Mug",sw:"Sword",buck:"Bucket"}[e]??"Item"),Z=e=>(()=>{switch(e){case"mugE":return"s_30";case"mugF":return"s_29";case"sw":return"s_31";case"buck":return"s_34"}})()??"s_0",ee=(e,t,r)=>{let i={...f(),name:e,x:t,y:r,draw(){if(i.remv)return;let e=Z(i.name);S(e,16*i.x,16*i.y)},drawAt(e,t,r){let l=Z(i.name);S(l+(r?"_f":""),e,t)}};return i},te=()=>{let e=0,t=0,r=0,i=0,l=()=>{let e=G().room;return e.tiles.reduce(((t,r)=>17===r[0]&&e.getTileLevel(r)<=i?t+1:t),0)},s={level:1,reset(){e=0,t=0,s.level=1,r=0,i=1},incScore(){t++,e++},incLevel(){let e=s.level;0===r&&e>=2&&e<=6||s.level>6?r++:(r=0,s.level++),i++,t=0},addCrateBonus(){e+=l()},getScore:()=>[t,l(),e],getTotalLevel:()=>i,isLevelComplete:(e,t)=>t.isDone()&&!e.patrons.find((e=>"person"===e.type))};return s},re=(e,t,r,i)=>{let l=g(e),s=new he(t);s.start(),l.start();let a=f(),o={...a,x:r,y:i,update(){a.update(),s.isDone()&&(o.remv=!0)},draw(){l.update(),S(l.getSprite(),16*o.x,16*o.y)}};return o},ie=([e,t])=>`${e},${t}`,le=(e,t,r,i,l,s)=>{1===pe(e,r,i)&&!l[ie(e)]&&(s.push({p:e,parent:t}),l[ie(e)]=!0)},se=(e,t,r)=>{let i,l,s=f(),a=new he("person"===e?150:300),o=new he(1e3),n=!1,m=new he(2e4),d=new he(3e3),c=new he(1e3),p=new he(2e3),u=new he(100),h="fs",v="findCrate",T={},x=e=>(T[e+="_l"]||(T[e]=g(e)),T[e]),b=e=>{if("person"===e)switch(h){case"fs":case"d":case"l":return x("p_walk");case"r":return x("p_angry");case"wfd":return m.pct()<.5?x("p_wait"):x("p2_wait");case"wfc":case"n":return x("p_wait")}else if("mole"===e)return x("mole");return x("mole")},L=e=>{h=e,"wfd"===e&&m.start(),"wfc"===e&&u.start(),"r"===e&&ve("patronAngry"),"l"===e&&G().tileOrch.restoreTile(C,"Table"),b("person").reset()},P=e=>{let t=G();v=e,"destroyCrate"!==e&&"destroyTable"!==e||p.start(),"findCrate"===e&&(t.tileOrch.restoreTile(C,"Crate"),t.tileOrch.isTileAvailable("Crate")||P("findTable")),"findTable"===e&&(t.tileOrch.restoreTile(C,"MoleTable"),t.tileOrch.isTileAvailable("MoleTable")||P("leaving")),"leaving"===e&&(t.tileOrch.restoreTile(C,"Crate"),t.tileOrch.restoreTile(C,"MoleTable")),b("mole").reset()},E=(e,t)=>{let r=G(),i=e.slice(1),l=((e,t,r,i)=>{let l=[],s=[{p:e}],a={[ie(e)]:!0},o=1e3;for(;s.length;){let e=s.shift();if(!e)return[];if(ue(e.p,t)){l.unshift(t);let r=e.parent;for(;r;)r.parent&&l.unshift(r.p),r=r.parent;break}for(let t of Ae(e.p))le(t,e,r,i,a,s);if(o--,o<=0)break}return l})(C.getPos(),i,((e,t)=>{let r=[],i=([e,r])=>t.find((t=>t.x===e&&t.y===r));for(let[t,s,a]of e.tiles)!_(l=t)&&!k(l)||i([s,a])?r.push(0):r.push(1);var l;return r})(r.room,r.patrons.concat([r.getPlayer()])),r.room.w),s=l[0];if(ue(s,C.getPos()))t();else if(s){let[e,t]=l[0],r=C.getPos();C.x=e,C.y=t,ae(C,r,(e=>{let t=G();ve("doorOpen"),t.room.setTileAt(C.x,C.y,e+1)}))}else if(n){if(o.isDone()){n=!1;for(let[e,t]of Ae(C.getPos())){let i=r.room.getTileAt(e,t);_(i[0])&&(C.x=e,C.y=t)}}}else n=!0,o.start()},M=e=>{let t=G();if(a.isDone()){if("person"===e)switch(h){case"fs":{let e=t.tileOrch.getAvailTile(C,"Table");e&&E(e,(()=>{L("wfd")}));break}case"l":{let e=t.tileOrch.getAvailTile(C,"Exit");e&&E(e,(()=>{C.remv=!0}))}}else if("mole"===e)switch(Math.random()>.9&&ve("moleAlert"),v){case"findCrate":{let e=t.tileOrch.getAvailTile(C,"Crate");e&&E(e,(()=>{P("destroyCrate")}));break}case"findTable":{let e=t.tileOrch.getAvailTile(C,"MoleTable");e&&E(e,(()=>{P("destroyTable")}));break}case"leaving":{let e=t.tileOrch.getAvailTile(C,"Exit");e&&E(e,(()=>{C.remv=!0}))}}a.start()}},C={...s,type:e,x:t,y:r,getState:()=>"person"===e?h:v,setPersonState(e){L(e)},getPos:()=>[C.x,C.y],update(){"person"===e?(()=>{let e=G();if(M("person"),"wfd"===h||"r"===h){m.isDone()&&"r"!==h?(L("r"),c.start()):"r"===h&&c.isDone()&&Math.random()>.95&&(e.setAdjTableOnFire(C.getPos()),c.start());let t=e.getAdjItem(C.getPos()),r=t?.[0];"mugF"!==r?.name||r?.remv||(r.remv=!0,i=r,l=t?.[2],L("d"),d.start())}else"d"===h?d.isDone()&&i&&l&&(L("wfc"),i.remv=!1,i.x=l[0],i.y=l[1],i.name="mugE",e.items.push(i),i=void 0):"wfc"===h&&u.isDone()&&(e.room.isTileVisible(C.x,C.y)&&ve("plusOne"),e.levelOrch.incScore(),e.particles.push(re("part_+1_l",300,C.x,C.y)),L("l"))})():"mole"===e&&(()=>{let e=G();if(M("mole"),"destroyCrate"===v&&p.isDone()){let t=e.getAdjTile(C.getPos(),[17]);t&&(ve("destroyCrate"),t[0]=A,P("findCrate"))}if("destroyTable"===v&&p.isDone()){let t=e.getAdjTile(C.getPos(),[y,w,21,22]);t&&(ve("destroyCrate"),t[0]=A,P("findCrate"))}})()},draw(){let t=b(e);t.update();let r=t.getSprite();S(r,16*C.x,16*C.y),"d"===h&&i&&i.drawAt(16*C.x+2,16*C.y+2)}};return C},ae=(e,[t,r],i)=>{let l=G(),s=l.room.getTileAt(t,r)?.[0],a=l.room.getTileAt(e.x,e.y)?.[0],o=l.getPatronAt(e.x,e.y);(e=>!_(e))(a)||o&&o!==e?(k(a)&&i(a),e.x=t,e.y=r):k(s-1)&&(ve("doorClose"),l.getPatronAt(t,r)||l.room.setTileAt(t,r,s-1))},oe=()=>{let d=new he(300),c=new he(80),g=new he(150),p=!1,u=e=>{e.remv=!0,void 0===T.itemLeft?(ve("item"),T.itemLeft=e):void 0===T.itemRight&&(ve("item"),T.itemRight=e)},h=e=>{let t=ee(e,T.x,T.y);t.remv=!0,ve("drawSword"),T.itemLeft=t,T.itemRight=t},w=(e,t)=>{let r=G(),i="item"+e,l=T[i];ve("itemPlace"),l.remv=!1,l.x=t[1],l.y=t[2],r.items.push(l),T[i]=void 0},y=e=>{ve("fill"),e.name="mugF"},v=e=>e.reduce(((e,t)=>e||ye(t)),!1);window.addEventListener("keydown",(f=>{let d=G();if(!d.isPaused()&&" "===f.key){let f=m(d);if(!f)return;let{type:c,tile:p,item:v}=f,x={[e]:()=>{u(v)},[t]:()=>{u(v)},[r]:()=>{h("sw")},[i]:()=>{h("buck")},[l]:()=>{w("Left",p)},[s]:()=>{"mugF"===T.itemLeft?.name?(w("Left",p),T.itemLeft=T.itemRight,T.itemRight=void 0):w("Right",p)},[a]:()=>{y(T.itemLeft)},[o]:()=>{y(T.itemRight)},sw:()=>{(()=>{let e=G();if(g.isDone()){g.start(),ve("swingSword");for(let[t,r]of Ae([T.x,T.y])){let i=e.getPatronAt(t,r);if("r"===i?.getState()||"mole"===i?.type){e.room.getTileAt(t,r)[0]!==A&&e.fParticles.push(re("bloodf_l",1/0,t,r)),e.particles.push(re("blood_l",300,t,r)),i.remv=!0,ve("hitSomething"),setTimeout((()=>{ve("mole"===i?.type?"moleDead":"personHit")}),300);break}}}})()},[n]:()=>{T.itemLeft=T.itemRight=void 0,ve("itemPlace")},"d-b":()=>{(()=>{T.itemLeft=void 0,T.itemRight=void 0,ve("dumpBucket");let e=G();for(let[t,r]of Ae([T.x,T.y],!0)){let[i]=e.room.getTileAt(t,r);if(15===i){e.room.setTileAt(t,r,A);for(let[i,l]of Ae([t,r])){let t=e.getPatronAt(i,l);"r"===t?.getState()&&t.setPersonState("wfd")}}e.particles.push(re("water_l",300,t,r))}})()},r:()=>{(e=>{let t=G(),[,r,i]=e,l=t.room.getTileAt(r,i,!0),[s]=l;e[0]=s,ve("fill")})(p)}};x[c]?.()}})),window.addEventListener("keyup",(e=>{p=!1,d.complete()}));let T=Object.assign(f(),{dir:"l",x:0,y:0,itemLeft:void 0,itemRight:void 0,ctrlEnabled:!0,reset(){},update(){(()=>{if(T.ctrlEnabled&&d.isDone()&&c.isDone()){let{x:e,y:t}=T,r=!1;v(["ArrowUp","8","7","9","Home","PageUp"])&&(T.y--,r=!0),v(["ArrowDown","2","1","3","End","PageDown"])&&(T.y++,r=!0),v(["ArrowLeft","7","4","1","Home","End"])&&(T.x--,r=!0),v(["ArrowRight","9","6","3","PageUp","PageDown"])&&(T.x++,r=!0),r&&ae(T,[e,t],(e=>{let t=G();ve("doorOpen"),t.room.setTileAt(T.x,T.y,e+1),d.start(),p=!0})),T.x===e&&T.y===t||(p?c.start():(d.start(),c.start(),p=!0))}})()},draw(){let e=0;T.itemLeft&&e++,T.itemRight&&e++;let t=void 0!==T.itemLeft&&T.itemLeft===T.itemRight;if(t&&(e--,g.isDone()||e--),S("s_"+e,16*T.x,16*T.y),t){let e=-4;g.isDone()||(e=2),T.itemLeft.drawAt(16*T.x-6,16*T.y+e,!0)}else T.itemLeft&&T.itemLeft.drawAt(16*T.x-8,16*T.y-5,!0),T.itemRight&&T.itemRight.drawAt(16*T.x+8,16*T.y-5)}});return T},ne=(e,t,r=[])=>{let i=new he(100),l=!1,s=[],a=e.map(((e,r)=>[e,r%t,Math.floor(r/t)])),o={...f(),w:t,h:t,spawns:r,visMaps:Y(e,t),tiles:a,reset:e=>{let t=structuredClone(a);for(let r=0;r<t.length;r++){let i=t[r],l=o.getTileLevel(i,!0);26===i[0]&&l>e&&i[0]--}o.tiles=t},getTileAt:(e,r,i)=>(i?a:o.tiles)[r*t+e]??[0],setTileAt:(e,r,i)=>{let l=o.tiles[r*t+e];l&&(l[0]=i)},getTileLevel:(e,r)=>{let[i,l,s]=e;if(0===i)return 0;let a=0;for(let e of o.visMaps){let i=e[s*t+l];if(i){let e=L(i);if(e>a&&(a=e,!r))return a}}return a},isTileVisible:(e,r)=>s.reduce(((i,l)=>i||pe([e,r],o.visMaps[l],t)>0),!1),update:()=>{s=(()=>{let e=G().getPlayer().getPos(),r=[];for(let i=0;i<o.visMaps.length;i++)pe(e,o.visMaps[i],t)>0&&r.push(i);return r})(),i.isDone()&&(i.start(),l=!l)},draw:()=>{for(let e=0;e<t;e++)for(let r=0;r<t;r++){let[i]=o.tiles[r+e*t],a=o.isTileVisible(r,e,s);i&&a?(15===i&&(i+=l?1:0),S("s_"+(i-1),16*r,16*e)):C(16*r,16*e,16,16,"#000")}}};return o},me=1e5,fe=()=>{let e=new he(1),t=new he(1),r=!1,i=1,l=0,s=0,a=0,o=0,n=0,m=e=>{let t,r,l=G(),s=(()=>{let e=G();return e.room.tiles.filter((t=>{for(let r of e.room.spawns)if(ue(r,t.slice(1))&&e.room.getTileLevel(t)<=i)return!0}))})(),a=Te(s);do{if(t=a[1],r=a[2],!l.getPatronAt(t,r))break;s.indexOf(a)>-1&&s.splice(s.indexOf(a),1),a=Te(s)}while(a&&s.length>0);if(!a)return!1;if("person"===e&&!l.tileOrch.isTileAvailable("Table"))return!1;let o=se(e,t,r);return l.patrons.push(o),!0},f={lvlTimer:new he(me+n),start:(m,d)=>{r=!0,e.ms=5e3+5e3*Math.random(),e.start(),d>5&&(n+=1e3),f.lvlTimer.ms=me+n,f.lvlTimer.start(),l=0,s=5+Math.floor(1.75*d),o=(()=>{switch(!0){case[5,7].includes(d):return 1;case[9].includes(d):return 2;case d>9:return 3;default:return 0}})(),t.ms=(me+n-1e4)/2/(o+1),t.start(),a=0,i=m},stop(){r=!1},isDone:()=>l>=s,getRemaining:()=>s-l,getMaxTime:()=>f.lvlTimer.ms,update(){r&&(this.isDone()||(e.isDone()&&(e.ms=1+Math.random()*Math.min(7e3,((me+n)/1.5-5e3)*(1-f.lvlTimer.pct())/2),e.start(),m("person")&&l++),t.isDone()&&a<o&&(t.start(),m("mole")&&(ve("moleAlert"),a++))))}};return f},de=(e,t)=>{let r=(e,t)=>t.includes(e),i=e.tiles.filter((r=>{let[i,l,s]=r;if(e.getTileLevel(r)<=t&&_(i)){let[t]=e.getTileAt(l,s-1),[r]=e.getTileAt(l-1,s),[i]=e.getTileAt(l+1,s);if(t===y||r===w||i===w)return!0}})).map((e=>[e,void 0])),l=e.tiles.filter((r=>{for(let i of e.spawns)if(ue(i,r.slice(1))&&e.getTileLevel(r)<=t)return!0})).map((e=>[e,void 0])),s=(r=[])=>e.tiles.filter((r=>{let[i,l,s]=r;if(e.getTileLevel(r)<=t&&_(i)){let[t]=e.getTileAt(l-1,s),[r]=e.getTileAt(l+1,s);if(17===t||17===r)return!0}})).map((e=>{let t=r.find((t=>t[0]===e))?.[1];return[e,t]})),a=(i=[])=>e.tiles.filter((i=>{let[l,s,a]=i;if(e.getTileLevel(i)<=t&&_(l)){let[t]=e.getTileAt(s,a+1),[i]=e.getTileAt(s,a-1),[l]=e.getTileAt(s-1,a),[o]=e.getTileAt(s+1,a);if(r(t,[w,y,21,22])||r(i,[w,21,22])||r(l,[y,21,22])||r(o,[y,21,22]))return!0}})).map((e=>{let t=i.find((t=>t[0]===e))?.[1];return[e,t]})),o=s(),n=a(),m=e=>({Table:i,Exit:l,Crate:o,MoleTable:n}[e]??[]);return{restoreTile:(e,t)=>{let r=m(t).find((t=>t[1]===e));r&&("Crate"===t&&(o=s(o)),"MoleTable"===t&&(n=a(n)),r[1]=void 0)},getAvailTile:(e,t)=>{let r=m(t).find((t=>t[1]===e));if(r)return r[0];let i=m(t).filter((e=>void 0===e[1]||"Exit"===t)),l=Te(i);return l?(l[1]=e,l[0]):void 0},isTileAvailable:e=>{let t=m(e).filter((t=>void 0===t[1]||"Exit"===e));return t?.length>0}}},ce=()=>window.performance.now(),ge=(e,t,r,i,l)=>i+(e-t)*(l-i)/(r-t),pe=([e,t],r,i)=>e<0||e>=i||t<0||t>=i?-1/0:r[e+t*i],ue=(e,t)=>e?.[0]===t?.[0]&&e?.[1]===t?.[1];class he{ms;s=-999;constructor(e){this.ms=e}start(){this.s=ce()}stop(){this.s=0}pct(){let e=ce()-this.s;return e>this.ms?e=this.ms:e<0&&(e=-1),Math.min(1,e/this.ms)}complete(){this.s=-999}isDone(){return ce()-this.s>=this.ms}}let we={};window.addEventListener("keydown",(e=>{we[e.key]=!0;let t=B(),r=parseInt(t.style.width);isNaN(r)&&(r=t.width),"+"===e.key&&(r+=100,t.style.width=r+"px"),"-"===e.key&&(r-=100,t.style.width=r+"px"),localStorage.setItem("js13k2023_tavernity_width",r+"")})),window.addEventListener("keyup",(e=>{we[e.key]=!1}));let ye=e=>we[e],ve=e=>{let t=(e=>{let t=c[e];if(!t)throw Error("No sound: "+e);return t})(e);be(t)},Te=e=>e[Math.floor(Me()*e.length)],Ae=([e,t],r)=>[[e-1,t],[e+1,t],[e,t-1],[e,t+1]]?.concat(r?[[e-1,t-1],[e-1,t+1],[e+1,t-1],[e+1,t+1]]:[]),xe=e=>{_e=e},be=e=>{Le(...e)},Le=(...e)=>Ee(Se(...e)),_e=.1,ke=44100,Pe=new(window.AudioContext||webkitAudioContext),Ee=(...e)=>{let t=Pe.createBuffer(e.length,e[0].length,ke),r=Pe.createBufferSource();return e.map(((e,r)=>t.getChannelData(r).set(e))),r.buffer=t,r.connect(Pe.destination),r.start(),r},Me=Math.random,Se=(e=1,t=.05,r=220,i=0,l=0,s=.1,a=0,o=1,n=0,m=0,f=0,d=0,c=0,g=0,p=0,u=0,h=0,w=1,y=0,v=0)=>{let T,A,x=2*Math.PI,b=n*=500*x/ke/ke,L=r*=(1+2*t*Me()-t)*x/ke,_=[],k=0,P=0,E=0,M=1,S=0,C=0,O=0;for(m*=500*x/ke**3,p*=x/ke,f*=x/ke,d*=ke,c=c*ke|0,A=(i=i*ke+9)+(y*=ke)+(l*=ke)+(s*=ke)+(h*=ke)|0;E<A;_[E++]=O)++C%(100*u|0)||(O=a?a>1?a>2?a>3?Math.sin((k%x)**3):Math.max(Math.min(Math.tan(k),1),-1):1-(2*k/x%2+2)%2:1-4*Math.abs(Math.round(k/x)-k/x):Math.sin(k),O=(c?1-v+v*Math.sin(x*E/c):1)*(O>0?1:-1)*Math.abs(O)**o*e*_e*(E<i?E/i:E<i+y?1-(E-i)/y*(1-w):E<i+y+l?w:E<A-h?(A-E-h)/s*w:0),O=h?O/2+(h>E?0:(E<A-h?1:(A-E)/h)*_[E-h|0]/2):O),T=(r+=n+=m)*Math.cos(p*P++),k+=T-T*g*(1-1e9*(Math.sin(E)+1)%2),M&&++M>d&&(r+=f,L+=f,M=0),!c||++S%c||(r=L,n=b,M=M||1);return _};