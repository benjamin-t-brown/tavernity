let e="pickup-left",t="pickup-right",i="pickup-weapon",r="pickup-bucket",l="putdown-left",a="putdown-right",n="fill-left",o="fill-right",s="swing-weapon",m="putdown-weapon",d="dump-bucket",f="repair",g=g=>{let c,u=g.getPlayer(),p=g.getAdjItem([u.x,u.y]);if("sword"===u.itemLeft?.name)return c=g.getAdjTile([u.x,u.y],[x]),c?{type:m}:{type:s};if("bucketFull"===u.itemLeft?.name)return c=g.getAdjTile([u.x,u.y],[k]),c?{type:r}:{type:d};if(c=g.getAdjTile([u.x,u.y],[b]))return{type:f,tile:c};if(!(!p||u.itemLeft&&u.itemRight)){let[i,,[r,l]]=p;if("mugFull"===p[0].name)for(let[e,t]of be([r,l])){let i=g.getPatronAt(e,t);if("waitForDrink"===i?.getState())return}return{type:u.itemLeft?t:e,item:i}}return u.itemLeft||u.itemRight||!(c=g.getAdjTile([u.x,u.y],[x]))?u.itemLeft||u.itemRight||!(c=g.getAdjTile([u.x,u.y],[k]))?"mugEmpty"===u.itemLeft?.name&&g.getAdjTile([u.x,u.y],v)?{type:n,item:u.itemLeft}:"mugEmpty"===u.itemRight?.name&&g.getAdjTile([u.x,u.y],v)?{type:o,item:u.itemRight}:u.itemRight&&!["sword"].includes(u.itemRight.name)&&(c=g.getAdjTile([u.x,u.y],y))&&!g.getItemAt(c[1],c[2])?{type:a,tile:c,item:u.itemRight}:u.itemLeft&&!["sword"].includes(u.itemLeft.name)&&(c=g.getAdjTile([u.x,u.y],y))&&!g.getItemAt(c[1],c[2])?{type:l,tile:c,item:u.itemLeft}:void 0:{type:r,tile:c}:{type:i,tile:c}},c=()=>{let e={x:0,y:0,scale:1,vx:0,vy:0,remv:!1,getPos:()=>[e.x,e.y],update:()=>{},draw:()=>{}};return e},u={},p={},h=e=>{let t=u[e];if(!t)throw Error("No anim: "+e);let[,i,...r]=t.split(" "),l=parseInt(i);return function([e,t,i]){let r,l,a,n,o=e||!1,s=[];s=[],r=!1,l=0,a=0,n=0,i.forEach((({n:e,d:t,offsetX:i,offsetY:r,opacity:a})=>{s.push({n:e||"",timestampBegin:l,timestampEnd:l+(t??0),d:t??0,durationUpToNow:l,offsetX:i||0,offsetY:r||0,opacity:a}),l+=t??0}));let m={reset(){r=!1,a=0,m.start()},start(){n=pe()},update(){let e=pe();if(a===s.length-1&&o&&e-n>l){let t=n+l;m.reset(),m.start(),e-t<l&&(n=t)}a=(e=>{let t=0,i=a,r=s.length-1;for(;i<=r;){let l=i+Math.floor((r-i)/2);t=l;let{timestampEnd:a,timestampBegin:o}=s[l],m=(a||0)+n;if(e<m&&e>(o||0)+n)return l;e>=m?i=l+1:r=l-1}return t})(e),o||e-n>=l&&(r=!0)},getSprite:()=>s[a]?.n};return m}([!0,e,r.map((e=>({n:e,d:l})))])},w=[12,14,27,28,29,39],y=[19,20,21,22],v=[18],T=20,A=19,x=13,k=24,b=14,L=["",'"Hey, barkeep!\nFill a mug and set it down\nhere in front of me."',"Looks like it's busy today.\nPatrons are overflowing to the side room.","In Case of Fire:\nFETCH BUCKET OF WATER\nFROM WELL OUTSIDE","We need more tables!\nOpen up the other side room!","We're attracting moles now!\nGrab a weapon when you see 'em!\nThat's why we have a weapons rack!","Business is booming!\nWe have a whole new taproom now!","A bigger tavern always\nattracts more moles.","We need to expand again!\nTheres even more space\nin the back.","A bouncer would be nice\nto remove of all these moles!","We can squeeze a few more\n in the private taproom."],_=[4,2,6,5,1,3],P=e=>_.indexOf(e)+1,S=e=>w.includes(e),E=e=>26===e,C={font:"monospace",color:"#fff",size:14,align:"center",strokeColor:"black"},M=1,D=e=>{M=e},O=(e,t,i,r,l)=>{r=r||1,l=l||H();let a="string"==typeof e?U(e):e;if(!a)throw Error(`No sprite: "${e}"`);let[n,o,s,m,d]=a;l.drawImage(n,o,s,m,d,t,i,m*r,d*r)},R=(e,t,i,r,l,a,n)=>{(n=n||H())[a?"strokeStyle":"fillStyle"]=l,n[a?"strokeRect":"fillRect"](e,t,i,r)},F=(e,t,i,r,l)=>{let{font:a,size:n,color:o,align:s,strokeColor:m}={...C,...r||{}};(l=l||H()).font=`${n}px ${a}`,l.textAlign=s,l.textBaseline="middle",m&&(l.strokeStyle=m,l.lineWidth=4,l.strokeText(e,t,i)),l.fillStyle=o,l.fillText(e,t,i)},j=null,I=null,z=null,B=e=>{let[t,i,r]=$(e.width,e.height);return i.translate(r,0),i.scale(-1,1),i.drawImage(e,0,0),t},W=e=>{let[,,,t,i]=e,[r,l]=$(t,i);return O(e,0,0,1,l),r},$=(e,t)=>{let i=document.createElement("canvas");i.width=e,i.height=t;let r=i.getContext("2d");return r.imageSmoothingEnabled=!1,[i,r,e,t]},N=()=>{if(j)return j;{let[e,t]=$(576,576);return e.id="canv",t.lineWidth=2,window.canvasDiv.appendChild(e),j=e,e}},H=()=>N().getContext("2d"),U=e=>z[e],V=(e,[t,i,r])=>S(we(e,t,r))&&-1===we(e,i,r),q=(e,t)=>{let i=[];for(let r=0;r<e**2;r++)i.push(t);return i},Y=(e,t,i)=>{let[r,l]=e,[,a,n]=t;V(e,t)&&(a[r+l*n]=i,be([r,l]).forEach((e=>{Y(e,t,i)})))},G=(e,t)=>{let i=t[1]||[],r=t[2];if(0===i.length)for(let e=0;e<r**2;e++)i.push(-1);for(let i=0;i<r**2;i++){let l=[i%r,Math.floor(i/r)];if(V(l,t))return Y(l,t,e),!0}return!1},X=(e,t,i,r)=>{let l=q(i,0),a=(r,l,n,o=!0)=>{var s;-1===we(r,e,i)&&(n.push([r[0]+r[1]*i,l]),o&&(s=t[r[0]+r[1]*i],[13,17,18,18,20,21,22].concat(w).includes(s))&&be(r,!0).forEach((e=>{a(e,l,n,!1)})))},n=[];for(let t=0;t<i;t++)for(let o=0;o<i;o++){let s=t*i+o;e[s]===r&&(l[s]=r,be([o,t],!0).forEach((e=>{a(e,r,n)})))}for(let[e,t]of n)l[e]=t;return l},K=(e,t)=>{let i=1,r=q(t,-1),l=[e,r,t];for(;G(i,l);)i++;let a=[];for(let l=1;l<i;l++)a.push(X(r,e,t,l));return a},J=()=>window.game;window.addEventListener("load",(()=>{Q()}));let Q=async()=>{Z()},Z=async()=>{await(async e=>{N();let t={},i={};await Promise.all([["sprite","res/sprite.png",16,16]].map((([e,r,l,a],n)=>new Promise((n=>{let o=new Image;o.onload=()=>{t[e]=o,((e,t,i,r,l)=>{let a=(t,i,r,l,a,n)=>{let[o,s]=$(a,n);return s.drawImage(i,r,l,a,n,0,0,a,n),e[t]=[o,0,0,a,n]},n=t.width/r,o=t.height/l;for(let e=0;e<o;e++)for(let i=0;i<n;i++){let o="s_"+(e*n+i),s=a(o,t,i*r,e*l,r,l);a(o+"_f",B(W(s)),0,0,r,l)}})(i,o,0,l,a),n()},o.src=r}))))),I=t,z=i})();let s=await(await fetch("res/map.json")).json();(()=>{let e=(e,t)=>{u[e]=t},t=[["mole",["s_9","s_10"]],["p_walk",["s_3"]],["p_wait",["s_3","s_4"]],["p2_wait",["s_5","s_6"]],["p_angry",["s_7","s_8"]],["part_+1",["s_39"]],["water",["s_40"]],["bloodf",["s_36"]],["blood",["s_35"]]];for(let[i,r]of t)e(i+"_l","t 300 "+r.join(" ")),e(i+"_r","t 300 "+r.map((e=>e+"_f")).join(" "));e("fire","t 150 s_14 s_15")})(),p.item=[,0,976,,,0,2,.15,-.4,,-547,.01,,,9.8,.1,,,.06,.03],p.itemPlace=[,0,104,,.15,.03,2,.38,,-61,,,.15,,,,,,.02,.36],p.doorOpen=[1.75,,151,.03,.01,.19,2,1.33,-9,,,,,.1,,,,.19,.01],p.doorClose=[1.24,,339,.12,.05,0,1,.42,-24,.1,,,.08,,-19,.6,,,,.79],p.step=[1.07,,309,.01,.03,.03,4,.72,,60,60,.04,,,-16,,.06,.09],p.fill=[1.09,,0,.19,,.02,,2.31,92,-25,927,,,,-1.4,.9,,.5,.09],p.moleDead=[2.1,,1360,.06,.09,.2,2,1.63,,,,,,.9,-.4,.1,.03,.57,,.01],p.moleAlert=[,,169,,.13,,2,2.18,.1,-7,,,.11,.6,,,,,.18,.05],p.plusOne=[1.12,,73,.02,.18,.06,2,.87,,,-190,.11,,,,,,.82,.01,.29],p.drawSword=[,,455,,.09,.01,2,2.31,,,-758,.01,.02,,,,,,.2,.59],p.swingSword=[,,232,.07,.02,0,4,.27,29,75,,,,.1,,,,,,.02],p.patronAngry=[1.29,,322,.03,.17,0,,.55,,-89,-843,.15,.09,.3,-234,,.02,,.09],p.dumpBucket=[1.99,,246,,.07,.03,4,.66,47,32,,,,,-.4,,.25,,.13,.83],p.hitSomething=[1.04,,772,,.07,.06,2,.31,90,-15,590,.02,,,,.3,,.47,.03],p.personHit=[,,495,.05,.19,0,3,.15,.1,,,,,,.4,,,,.03,.02],p.repair=[1.04,,610,.04,.18,.04,,.79,33,,,,,.2,85,.1,,.27],p.fire=[1.06,,1028,.11,.14,.03,4,.15,-4.8,,-690,.18,,.1,,.4,.07,.99,.15],p.destroyCrate=[,,80,.04,.03,.2,4,.34,-.3,,,,,,-9.9,,,,.18],p.levelDone=[1.04,,3,.06,.09,.09,1,.84,,14,,,,,5.2,,,.43,.13],p.levelScreen=[1.85,,123,.15,.15,.01,2,1.15,,-54,,,.26,,.3,,.06,.7,.03,.04],p.startLevel=[1.05,,0,.01,.17,.17,1,1.56,,73,225,.01,.09,,-.1,,,.43],p.gameOver=[1.7,,146,.22,.07,.18,4,2.48,,82,,,,,253,,.21,,,.01],p.timerTick=[,,1091,.18,.02,.17,4,.91,,-42,,,,,167,,,,.02];let d=+localStorage.getItem("js13k2023_tavernity_width");!isNaN(d)&&d>0&&(N().style.width=d+"px"),ee(function(s,d,c){let u=fe(s,d,c),p=ce(),h=le(),w=new ve(1e3),y=new ve(3e3),v=!1,x=!1,k="",b=0,_=0,P=document.getElementById("key-info").children[0],S="",E=window.player=de(),C=!0,M=!1,D=!1,j=!1;new ve(2e3),window.addEventListener("keydown",(e=>{" "===e.key&&setTimeout((()=>{C?(xe("itemPlace"),z(),W()):M?(xe("itemPlace"),B()):D?(xe("startLevel"),$()):j&&(xe("itemPlace"),U())}),1)}));let I=()=>G.patrons.reduce(((e,t)=>["waitForDrink","findSeat","rioting"].includes(t.getState())?e+1:e),0),z=()=>{G.setup(),C=!1},B=()=>{M=!1,v=!1,h.incLevel(),W()},W=()=>{Y(),G.update(1),k=L[G.levelOrch.getTotalLevel()]??"And they just keep coming...",D=!0},$=()=>{Y(),D=!1,v=!1},U=()=>{j=!1,C=!0,G.setup()},V=e=>{for(let t=0;t<e.length;t++){let i=e[t];i.update(),i.remv&&(e.splice(t,1),t--)}},q=e=>{for(let t=0;t<e.length;t++){let i=e[t];G.room.isTileVisible(i.x,i.y)&&i.draw()}},Y=()=>{G.patrons=[],G.particles=[],G.fParticles=[],G.tileOrch=ue(u,h.level);let e=h.getTotalLevel();if(0===G.items.length)for(let[e,t]of[[5,11],[5,12],[8,10],[4,15],[21,9],[21,10],[17,13],[15,3],[21,3]])G.items.push(re("mugEmpty",e,t));1===e&&G.patrons.push(se("person",11,14)),E.x=10,E.y=12,p.start(h.level,e),G.room&&G.room.reset(h.level),E.reset(),b=0},G={cx:0,cy:0,scale:4,room:u,tileOrch:ue(u,1),levelOrch:h,items:[],patrons:[],particles:[],fParticles:[],setup(){h.reset(),G.items=[],Y(),v=!1},isPaused:()=>C||M||D||j,setAdjTableOnFire(e){let t=G.getAdjTile(e,[A,T]);if(t&&15!==t[0]){let[,e,i]=t;G.room.setTileAt(e,i,15);let r=G.getItemAt(e,i);xe("fire"),r&&"mugFull"===r.name&&(r.name="mugEmpty")}},getPlayer:()=>E,getItemAt:(e,t)=>G.items.find((i=>i.x===e&&i.y===t)),getPatronAt:(e,t)=>G.patrons.find((i=>i.x===e&&i.y===t)),getAdjTile([e,t],i){for(let r of i)for(let[i,l]of be([e,t]).concat([[e,t]])){let e=G.room.getTileAt(i,l);if(e&&e[0]===r)return e}},getAdjItem([e,t]){let i,r,l=0,a=be([e,t]).concat([[e,t]]);for(let e of G.items)for(let[t,n]of a)e.x===t&&e.y===n&&(i&&i.name!==e.name||(l++,i=e,r=[t,n]));if(i&&r)return[i,l,r]},update(e){if(G.isPaused())return;p.update(),u.update(),V(G.patrons),E.update(),V(G.particles),V(G.fParticles),V(G.items);let t=N();G.cx=16*E.x*G.scale-t.width/2+8*G.scale,G.cy=16*E.y*G.scale-t.height/2+8*G.scale,h.isLevelComplete(G,p)&&!M&&(v?y.isDone()&&(v=!1,M||(P.style.opacity="0",M=!0,E.x=0,E.y=0,xe("levelScreen"),h.addCrateBonus())):(xe("levelDone"),v=!0,y.start())),I()>0&&p.lvlTimer.isDone()&&(xe("gameOver"),j=!0,P.style.opacity="0",_=h.getScore()[2])},draw(){let s=H();if(C)return void(()=>{w.isDone()&&(x=!x,w.start());let e=H(),{width:t,height:i}=e.canvas,r=G.scale;R(0,0,t,i,"#000");let l=(e,t,i)=>{for(let r=0;r<9;r++)i?O("s_24",e,16*r*t,t):O("s_24",16*r*t,e,t)};l(0,r),l(i-16*r,r),l(0,G.scale,!0),l(t-16*r,r,!0),P.style.opacity="0";for(let e=0;e<7;e++)for(let t=0;t<7;t++)O("s_11",16*r+16*t*r,16*r+16*e*r,r);O("s_17",t/2-16*r/2,i/2-16*r/2,r),O("s_18",t/2-16*r/2-16*r,i/2-16*r/2,r),O(x?"s_29":"s_30",t/2-16*r/2-16*r,i/2-16*r/2,r),O("s_18",t/2-16*r/2+16*r,i/2-16*r/2,r),O(x?"s_30":"s_29",t/2-16*r/2+16*r,i/2-16*r/2,r),F("TAVERNITY",t/2,i/2-32*r,{size:42,align:"center"}),F('"Serve me quick, barkeep,\nbefore I get angry."',t/2,i/2-16*r,{size:16,align:"center"}),F("Last Score: "+_,t/2,i/2+16*r,{size:24,align:"center"}),F("Press (SPACE) to continue.",t/2,i/2+32*r+16,{size:24,align:"center"})})();if(M)return void(()=>{let e=H(),{width:t,height:i}=e.canvas,r=G.scale;R(0,0,t,i,"#000");let[l,a,n]=h.getScore(),o={size:24,align:"center"};F(`Level ${h.getTotalLevel()} Complete`,t/2,i/2-32*r,{size:42,align:"center"}),F("Round Score: "+l,t/2,i/2+12*r,{size:24,align:"center"}),F("Crate Bonus: "+a,t/2,i/2+24*r,o),F("Total Score: "+n,t/2,i/2+36*r,o),F("Press (SPACE) to start",t/2,i/2+48*r+16,o)})();if(j)return void(()=>{let e=H(),{width:t,height:i}=e.canvas,[,,r]=h.getScore(),l=G.scale;R(0,0,t,i,"#000"),F("GAME OVER",t/2,i/2-32*l,{size:42,align:"center"}),F("Total Score: "+r,t/2,i/2+36*l,{size:24,align:"center"}),F("Press (SPACE) to start",t/2,i/2+48*l+16,{size:24,align:"center"})})();s.save(),s.translate(-G.cx,-G.cy),s.scale(G.scale,G.scale),G.room.draw(),q(G.fParticles),q(G.items),q(G.patrons),E.draw(),q(G.particles);let d=g(G);if(d){let{type:s,item:g}=d,c="",u="(SPACE)";switch(s){case e:case t:c=`Pick up ${te(g.name)} ${u}`;break;case i:c="Pick up Sword "+u;break;case r:c="Pick up Water Bucket "+u;break;case l:case a:c=`Place ${te(g.name)} ${u}`;break;case n:case o:c="Fill Mug "+u;break;case m:c="Put away Sword "+u;break;case f:c="Repair "+u}S===c&&""!==S||(P.style.opacity=""===c?"0":"1",P.innerHTML=c,S=c)}else P.style.opacity="0",S="";s.restore(),(()=>{let e=H(),{width:t,height:i}=e.canvas,r=I();if(F(""+(p.getRemaining()+r),64,32,{size:24,align:"left"}),R(4,4,48,52,"rgba(255, 255, 255, 0.5)"),O("s_3",4,4,3),F("Level: "+h.getTotalLevel(),16,i-16,{size:24,align:"left"}),v)F("Level ending soon...",t/2,128,{size:24,align:"center"});else if(!(D||p.isDone()&&0===r)){let e=Math.floor((1-p.lvlTimer.pct())*p.getMaxTime()/1e3);F("Time: "+Math.floor(e),t-(e<=10?16:24),16,{size:e<=10?32:24,align:"right"}),b!==e&&(b=e,e<=10&&xe("timerTick"))}})(),D&&(()=>{let e=k.split("\n"),t=e.length,i=H(),{width:r,height:l}=i.canvas,a=G.scale,n=1===t?0:-(12*a+16*t)/2;R(0,l/2+n-16,r,12*t*a+16,"#000");for(let i=0;i<t;i++)F(e[i],r/2,l/2+12*i*a+16+n,{size:24,align:"center"})})()}};return window.game=G,G.setup(),G}(s.tiles,s.width,s.spawns))},ee=e=>{let t=performance.now(),i=he(22,16,30,1,2),r=()=>{(()=>{let e=N();R(0,0,e.width,e.height,"grey")})(),e.draw(),requestAnimationFrame(r)};setInterval((()=>{let r=performance.now(),l=r-t;t=r,l>4&&(l=4);let a=l;l-=a;let n=a*i/10;D(n),e.update(n)}),22),r()};window.vol=e=>{Le(.3*+e.value/100)};let te=e=>({mugEmpty:"Mug",mugFull:"Mug",sword:"Sword",hammer:"Hammer",bucketFull:"Bucket"}[e]??"Item"),ie=e=>(()=>{switch(e){case"mugEmpty":return"s_30";case"mugFull":return"s_29";case"sword":return"s_31";case"bucketFull":return"s_34"}})()??"s_0",re=(e,t,i)=>{let r={...c(),name:e,x:t,y:i,draw(){if(r.remv)return;let e=ie(r.name);O(e,16*r.x,16*r.y)},drawAt(e,t,i){let l=ie(r.name);O(l+(i?"_f":""),e,t)}};return r},le=()=>{let e=0,t=0,i=0,r=0,l=()=>{let e=J().room;return e.tiles.reduce(((t,i)=>17===i[0]&&e.getTileLevel(i)<=r?t+1:t),0)},a={level:1,reset(){e=0,t=0,a.level=1,i=0,r=1},incScore(){t++,e++},incLevel(){let e=a.level;0===i&&e>=2&&e<=6||a.level>6?i++:(i=0,a.level++),r++,t=0},addCrateBonus(){e+=l()},getScore:()=>[t,l(),e],getTotalLevel:()=>r,isLevelComplete:(e,t)=>t.isDone()&&!e.patrons.find((e=>"person"===e.type))};return a},ae=(e,t,i,r)=>{let l=h(e),a=new ve(t);a.start(),l.start();let n=c(),o={...n,x:i,y:r,update(){n.update(),a.isDone()&&(o.remv=!0)},draw(){l.update(),O(l.getSprite(),16*o.x,16*o.y)}};return o},ne=([e,t])=>`${e},${t}`,oe=(e,t,i,r,l,a)=>{1===we(e,i,r)&&!l[ne(e)]&&(a.push({p:e,parent:t}),l[ne(e)]=!0)},se=(e,t,i)=>{let r,l,a=c(),n=new ve("person"===e?150:300),o=new ve(1e3),s=!1,m=new ve(2e4),d=new ve(3e3),f=new ve(1e3),g=new ve(2e3),u=new ve(100),p="findSeat",w="findCrate",y={},v=e=>(y[e+="_l"]||(y[e]=h(e)),y[e]),x=e=>{if("person"===e)switch(p){case"findSeat":case"drinking":case"leaving":return v("p_walk");case"rioting":return v("p_angry");case"waitForDrink":return m.pct()<.5?v("p_wait"):v("p2_wait");case"waitForClear":case"none":return v("p_wait")}else if("mole"===e)return v("mole");return v("mole")},k=e=>{p=e,"waitForDrink"===e&&m.start(),"waitForClear"===e&&u.start(),"rioting"===e&&xe("patronAngry"),"leaving"===e&&J().tileOrch.restoreTile(C,"Table"),x("person").reset()},L=e=>{let t=J();w=e,"destroyCrate"!==e&&"destroyTable"!==e||g.start(),"findCrate"===e&&(t.tileOrch.restoreTile(C,"Crate"),t.tileOrch.isTileAvailable("Crate")||L("findTable")),"findTable"===e&&(t.tileOrch.restoreTile(C,"MoleTable"),t.tileOrch.isTileAvailable("MoleTable")||L("leaving")),"leaving"===e&&(t.tileOrch.restoreTile(C,"Crate"),t.tileOrch.restoreTile(C,"MoleTable")),x("mole").reset()},_=(e,t)=>{let i=J(),r=e.slice(1),l=((e,t,i,r)=>{let l=[],a=[{p:e}],n={[ne(e)]:!0},o=1e3;for(;a.length;){let e=a.shift();if(!e)return[];if(ye(e.p,t)){l.unshift(t);let i=e.parent;for(;i;)i.parent&&l.unshift(i.p),i=i.parent;break}for(let t of be(e.p))oe(t,e,i,r,n,a);if(o--,o<=0)break}return l})(C.getPos(),r,((e,t)=>{let i=[],r=([e,i])=>t.find((t=>t.x===e&&t.y===i));for(let[t,a,n]of e.tiles)!S(l=t)&&!E(l)||r([a,n])?i.push(0):i.push(1);var l;return i})(i.room,i.patrons.concat([i.getPlayer()])),i.room.w),a=l[0];if(ye(a,C.getPos()))t();else if(a){let[e,t]=l[0],i=C.getPos();C.x=e,C.y=t,me(C,i,(e=>{let t=J();xe("doorOpen"),t.room.setTileAt(C.x,C.y,e+1)}))}else if(s){if(o.isDone()){s=!1;for(let[e,t]of be(C.getPos())){let r=i.room.getTileAt(e,t);S(r[0])&&(C.x=e,C.y=t)}}}else s=!0,o.start()},P=e=>{let t=J();if(n.isDone()){if("person"===e)switch(p){case"findSeat":{let e=t.tileOrch.getAvailTile(C,"Table");e&&_(e,(()=>{k("waitForDrink")}));break}case"leaving":{let e=t.tileOrch.getAvailTile(C,"Exit");e&&_(e,(()=>{C.remv=!0}))}}else if("mole"===e)switch(Math.random()>.9&&xe("moleAlert"),w){case"findCrate":{let e=t.tileOrch.getAvailTile(C,"Crate");e&&_(e,(()=>{L("destroyCrate")}));break}case"findTable":{let e=t.tileOrch.getAvailTile(C,"MoleTable");e&&_(e,(()=>{L("destroyTable")}));break}case"leaving":{let e=t.tileOrch.getAvailTile(C,"Exit");e&&_(e,(()=>{C.remv=!0}))}}n.start()}},C={...a,type:e,x:t,y:i,getState:()=>"person"===e?p:w,setPersonState(e){k(e)},getPos:()=>[C.x,C.y],update(){"person"===e?(()=>{let e=J();if(P("person"),"waitForDrink"===p||"rioting"===p){m.isDone()&&"rioting"!==p?(k("rioting"),f.start()):"rioting"===p&&f.isDone()&&Math.random()>.95&&(e.setAdjTableOnFire(C.getPos()),f.start());let t=e.getAdjItem(C.getPos()),i=t?.[0];"mugFull"!==i?.name||i?.remv||(i.remv=!0,r=i,l=t?.[2],k("drinking"),d.start())}else"drinking"===p?d.isDone()&&r&&l&&(k("waitForClear"),r.remv=!1,r.x=l[0],r.y=l[1],r.name="mugEmpty",e.items.push(r),r=void 0):"waitForClear"===p&&u.isDone()&&(e.room.isTileVisible(C.x,C.y)&&xe("plusOne"),e.levelOrch.incScore(),e.particles.push(ae("part_+1_l",300,C.x,C.y)),k("leaving"))})():"mole"===e&&(()=>{let e=J();if(P("mole"),"destroyCrate"===w&&g.isDone()){let t=e.getAdjTile(C.getPos(),[17]);t&&(xe("destroyCrate"),t[0]=b,L("findCrate"))}if("destroyTable"===w&&g.isDone()){let t=e.getAdjTile(C.getPos(),[A,T,21,22]);t&&(xe("destroyCrate"),t[0]=b,L("findCrate"))}})()},draw(){let t=x(e);t.update();let i=t.getSprite();O(i,16*C.x,16*C.y),"drinking"===p&&r&&r.drawAt(16*C.x+2,16*C.y+2)}};return C},me=(e,[t,i],r)=>{let l=J(),a=l.room.getTileAt(t,i)?.[0],n=l.room.getTileAt(e.x,e.y)?.[0],o=l.getPatronAt(e.x,e.y);(e=>!S(e))(n)||o&&o!==e?(E(n)&&r(n),e.x=t,e.y=i):E(a-1)&&(xe("doorClose"),l.getPatronAt(t,i)||l.room.setTileAt(t,i,a-1))},de=()=>{let u=new ve(300),p=new ve(80),h=new ve(150),w=!1,y=e=>{e.remv=!0,void 0===k.itemLeft?(xe("item"),k.itemLeft=e):void 0===k.itemRight&&(xe("item"),k.itemRight=e)},v=e=>{let t=re(e,k.x,k.y);t.remv=!0,xe("drawSword"),k.itemLeft=t,k.itemRight=t},T=(e,t)=>{let i=J(),r="item"+e,l=k[r];xe("itemPlace"),l.remv=!1,l.x=t[1],l.y=t[2],i.items.push(l),k[r]=void 0},A=e=>{xe("fill"),e.name="mugFull"},x=e=>e.reduce(((e,t)=>e||Ae(t)),!1);window.addEventListener("keydown",(c=>{let u=J();if(!u.isPaused()&&" "===c.key){let c=g(u);if(!c)return;let{type:p,tile:w,item:x}=c,L={[e]:()=>{y(x)},[t]:()=>{y(x)},[i]:()=>{v("sword")},[r]:()=>{v("bucketFull")},[l]:()=>{T("Left",w)},[a]:()=>{"mugFull"===k.itemLeft?.name?(T("Left",w),k.itemLeft=k.itemRight,k.itemRight=void 0):T("Right",w)},[n]:()=>{A(k.itemLeft)},[o]:()=>{A(k.itemRight)},[s]:()=>{(()=>{let e=J();if(h.isDone()){h.start(),xe("swingSword");for(let[t,i]of be([k.x,k.y])){let r=e.getPatronAt(t,i);if("rioting"===r?.getState()||"mole"===r?.type){e.room.getTileAt(t,i)[0]!==b&&e.fParticles.push(ae("bloodf_l",1/0,t,i)),e.particles.push(ae("blood_l",300,t,i)),r.remv=!0,xe("hitSomething"),setTimeout((()=>{xe("mole"===r?.type?"moleDead":"personHit")}),300);break}}}})()},[m]:()=>{k.itemLeft=k.itemRight=void 0,xe("itemPlace")},[d]:()=>{(()=>{k.itemLeft=void 0,k.itemRight=void 0,xe("dumpBucket");let e=J();for(let[t,i]of be([k.x,k.y],!0)){let[r]=e.room.getTileAt(t,i);if(15===r){e.room.setTileAt(t,i,b);for(let[r,l]of be([t,i])){let t=e.getPatronAt(r,l);"rioting"===t?.getState()&&t.setPersonState("waitForDrink")}}e.particles.push(ae("water_l",300,t,i))}})()},[f]:()=>{(e=>{let t=J(),[,i,r]=e,l=t.room.getTileAt(i,r,!0),[a]=l;e[0]=a,xe("repair")})(w)}};L[p]?.()}})),window.addEventListener("keyup",(e=>{w=!1,u.complete()}));let k=Object.assign(c(),{dir:"l",x:0,y:0,itemLeft:void 0,itemRight:void 0,ctrlEnabled:!0,reset(){},update(){(()=>{if(k.ctrlEnabled&&u.isDone()&&p.isDone()){let{x:e,y:t}=k,i=!1;x(["ArrowUp","8","7","9","Home","PageUp"])&&(k.y--,i=!0),x(["ArrowDown","2","1","3","End","PageDown"])&&(k.y++,i=!0),x(["ArrowLeft","7","4","1","Home","End"])&&(k.x--,i=!0),x(["ArrowRight","9","6","3","PageUp","PageDown"])&&(k.x++,i=!0),i&&me(k,[e,t],(e=>{let t=J();xe("doorOpen"),t.room.setTileAt(k.x,k.y,e+1),u.start(),w=!0})),k.x===e&&k.y===t||(w?p.start():(u.start(),p.start(),w=!0))}})()},draw(){let e=0;k.itemLeft&&e++,k.itemRight&&e++;let t=void 0!==k.itemLeft&&k.itemLeft===k.itemRight;if(t&&(e--,h.isDone()||e--),O("s_"+e,16*k.x,16*k.y),t){let e=-4;h.isDone()||(e=2),k.itemLeft.drawAt(16*k.x-6,16*k.y+e,!0)}else k.itemLeft&&k.itemLeft.drawAt(16*k.x-8,16*k.y-5,!0),k.itemRight&&k.itemRight.drawAt(16*k.x+8,16*k.y-5)}});return k},fe=(e,t,i=[])=>{let r=new ve(100),l=!1,a=[],n=e.map(((e,i)=>[e,i%t,Math.floor(i/t)])),o={...c(),w:t,h:t,spawns:i,visMaps:K(e,t),tiles:n,reset:e=>{let t=structuredClone(n);for(let i=0;i<t.length;i++){let r=t[i],l=o.getTileLevel(r,!0);26===r[0]&&l>e&&r[0]--}o.tiles=t},getTileAt:(e,i,r)=>(r?n:o.tiles)[i*t+e]??[0],setTileAt:(e,i,r)=>{let l=o.tiles[i*t+e];l&&(l[0]=r)},getTileLevel:(e,i)=>{let[r,l,a]=e;if(0===r)return 0;let n=0;for(let e of o.visMaps){let r=e[a*t+l];if(r){let e=P(r);if(e>n&&(n=e,!i))return n}}return n},isTileVisible:(e,i)=>a.reduce(((r,l)=>r||we([e,i],o.visMaps[l],t)>0),!1),update:()=>{a=(()=>{let e=J().getPlayer().getPos(),i=[];for(let r=0;r<o.visMaps.length;r++)we(e,o.visMaps[r],t)>0&&i.push(r);return i})(),r.isDone()&&(r.start(),l=!l)},draw:()=>{for(let e=0;e<t;e++)for(let i=0;i<t;i++){let[r]=o.tiles[i+e*t],n=o.isTileVisible(i,e,a);r&&n?(15===r&&(r+=l?1:0),O("s_"+(r-1),16*i,16*e)):R(16*i,16*e,16,16,"#000")}}};return o},ge=1e5,ce=()=>{let e=new ve(1),t=new ve(1),i=!1,r=1,l=0,a=0,n=0,o=0,s=0,m=e=>{let t,i,l=J(),a=(()=>{let e=J();return e.room.tiles.filter((t=>{for(let i of e.room.spawns)if(ye(i,t.slice(1))&&e.room.getTileLevel(t)<=r)return!0}))})(),n=ke(a);do{if(t=n[1],i=n[2],!l.getPatronAt(t,i))break;a.indexOf(n)>-1&&a.splice(a.indexOf(n),1),n=ke(a)}while(n&&a.length>0);if(!n)return!1;if("person"===e&&!l.tileOrch.isTileAvailable("Table"))return!1;let o=se(e,t,i);return l.patrons.push(o),!0},d={lvlTimer:new ve(ge+s),start:(m,f)=>{i=!0,e.ms=5e3+5e3*Math.random(),e.start(),f>5&&(s+=1e3),d.lvlTimer.ms=ge+s,d.lvlTimer.start(),l=0,a=5+Math.floor(1.75*f),o=(()=>{switch(!0){case[5,7].includes(f):return 1;case[9].includes(f):return 2;case f>9:return 3;default:return 0}})(),t.ms=(ge+s-1e4)/2/(o+1),t.start(),n=0,r=m},stop(){i=!1},isDone:()=>l>=a,getRemaining:()=>a-l,getMaxTime:()=>d.lvlTimer.ms,update(){i&&(this.isDone()||(e.isDone()&&(e.ms=1+Math.random()*Math.min(7e3,((ge+s)/1.5-5e3)*(1-d.lvlTimer.pct())/2),e.start(),m("person")&&l++),t.isDone()&&n<o&&(t.start(),m("mole")&&(xe("moleAlert"),n++))))}};return d},ue=(e,t)=>{let i=(e,t)=>t.includes(e),r=e.tiles.filter((i=>{let[r,l,a]=i;if(e.getTileLevel(i)<=t&&S(r)){let[t]=e.getTileAt(l,a-1),[i]=e.getTileAt(l-1,a),[r]=e.getTileAt(l+1,a);if(t===A||i===T||r===T)return!0}})).map((e=>[e,void 0])),l=e.tiles.filter((i=>{for(let r of e.spawns)if(ye(r,i.slice(1))&&e.getTileLevel(i)<=t)return!0})).map((e=>[e,void 0])),a=(i=[])=>e.tiles.filter((i=>{let[r,l,a]=i;if(e.getTileLevel(i)<=t&&S(r)){let[t]=e.getTileAt(l-1,a),[i]=e.getTileAt(l+1,a);if(17===t||17===i)return!0}})).map((e=>{let t=i.find((t=>t[0]===e))?.[1];return[e,t]})),n=(r=[])=>e.tiles.filter((r=>{let[l,a,n]=r;if(e.getTileLevel(r)<=t&&S(l)){let[t]=e.getTileAt(a,n+1),[r]=e.getTileAt(a,n-1),[l]=e.getTileAt(a-1,n),[o]=e.getTileAt(a+1,n);if(i(t,[T,A,21,22])||i(r,[T,21,22])||i(l,[A,21,22])||i(o,[A,21,22]))return!0}})).map((e=>{let t=r.find((t=>t[0]===e))?.[1];return[e,t]})),o=a(),s=n(),m=e=>({Table:r,Exit:l,Crate:o,MoleTable:s}[e]??[]);return{restoreTile:(e,t)=>{let i=m(t).find((t=>t[1]===e));i&&("Crate"===t&&(o=a(o)),"MoleTable"===t&&(s=n(s)),i[1]=void 0)},getAvailTile:(e,t)=>{let i=m(t).find((t=>t[1]===e));if(i)return i[0];let r=m(t).filter((e=>void 0===e[1]||"Exit"===t)),l=ke(r);return l?(l[1]=e,l[0]):void 0},isTileAvailable:e=>{let t=m(e).filter((t=>void 0===t[1]||"Exit"===e));return t?.length>0}}},pe=()=>window.performance.now(),he=(e,t,i,r,l)=>r+(e-t)*(l-r)/(i-t),we=([e,t],i,r)=>e<0||e>=r||t<0||t>=r?-1/0:i[e+t*r],ye=(e,t)=>e?.[0]===t?.[0]&&e?.[1]===t?.[1];class ve{ms;s=-999;constructor(e){this.ms=e}start(){this.s=pe()}stop(){this.s=0}pct(){let e=pe()-this.s;return e>this.ms?e=this.ms:e<0&&(e=-1),Math.min(1,e/this.ms)}complete(){this.s=-999}isDone(){return pe()-this.s>=this.ms}}let Te={};window.addEventListener("keydown",(e=>{Te[e.key]=!0;let t=N(),i=parseInt(t.style.width);isNaN(i)&&(i=t.width),"+"===e.key&&(i+=100,t.style.width=i+"px"),"-"===e.key&&(i-=100,t.style.width=i+"px"),localStorage.setItem("js13k2023_tavernity_width",i+"")})),window.addEventListener("keyup",(e=>{Te[e.key]=!1}));let Ae=e=>Te[e],xe=e=>{let t=(e=>{let t=p[e];if(!t)throw Error("No sound: "+e);return t})(e);_e(t)},ke=e=>e[Math.floor(De()*e.length)],be=([e,t],i)=>[[e-1,t],[e+1,t],[e,t-1],[e,t+1]]?.concat(i?[[e-1,t-1],[e-1,t+1],[e+1,t-1],[e+1,t+1]]:[]),Le=e=>{Se=e},_e=e=>{Pe(...e)},Pe=(...e)=>Me(Oe(...e)),Se=.1,Ee=44100,Ce=new(window.AudioContext||webkitAudioContext),Me=(...e)=>{let t=Ce.createBuffer(e.length,e[0].length,Ee),i=Ce.createBufferSource();return e.map(((e,i)=>t.getChannelData(i).set(e))),i.buffer=t,i.connect(Ce.destination),i.start(),i},De=Math.random,Oe=(e=1,t=.05,i=220,r=0,l=0,a=.1,n=0,o=1,s=0,m=0,d=0,f=0,g=0,c=0,u=0,p=0,h=0,w=1,y=0,v=0)=>{let T,A,x=2*Math.PI,k=s*=500*x/Ee/Ee,b=i*=(1+2*t*De()-t)*x/Ee,L=[],_=0,P=0,S=0,E=1,C=0,M=0,D=0;for(m*=500*x/Ee**3,u*=x/Ee,d*=x/Ee,f*=Ee,g=g*Ee|0,A=(r=r*Ee+9)+(y*=Ee)+(l*=Ee)+(a*=Ee)+(h*=Ee)|0;S<A;L[S++]=D)++M%(100*p|0)||(D=n?n>1?n>2?n>3?Math.sin((_%x)**3):Math.max(Math.min(Math.tan(_),1),-1):1-(2*_/x%2+2)%2:1-4*Math.abs(Math.round(_/x)-_/x):Math.sin(_),D=(g?1-v+v*Math.sin(x*S/g):1)*(D>0?1:-1)*Math.abs(D)**o*e*Se*(S<r?S/r:S<r+y?1-(S-r)/y*(1-w):S<r+y+l?w:S<A-h?(A-S-h)/a*w:0),D=h?D/2+(h>S?0:(S<A-h?1:(A-S)/h)*L[S-h|0]/2):D),T=(i+=s+=m)*Math.cos(u*P++),_+=T-T*c*(1-1e9*(Math.sin(S)+1)%2),E&&++E>f&&(i+=d,b+=d,E=0),!g||++C%g||(i=b,s=k,E=E||1);return L};