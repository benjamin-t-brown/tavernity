let e="pickup-left",t="pickup-right",i="pickup-weapon",r="pickup-bucket",l="putdown-left",a="putdown-right",n="fill-left",s="fill-right",o="swing-weapon",m="putdown-weapon",d="dump-bucket",c="repair",f=f=>{let g,p=f.getPlayer(),u=f.getAdjItem([p.x,p.y]);if("sword"===p.itemLeft?.name)return g=f.getAdjTile([p.x,p.y],[x]),g?{type:m}:{type:o};if("bucketFull"===p.itemLeft?.name)return g=f.getAdjTile([p.x,p.y],[k]),g?{type:r}:{type:d};if(g=f.getAdjTile([p.x,p.y],[b]))return{type:c,tile:g};if(!(!u||p.itemLeft&&p.itemRight)){let[i,,[r,l]]=u;if("mugFull"===u[0].name)for(let[e,t]of be([r,l])){let i=f.getPatronAt(e,t);if("waitForDrink"===i?.getState())return}return{type:p.itemLeft?t:e,item:i}}return p.itemLeft||p.itemRight||!(g=f.getAdjTile([p.x,p.y],[x]))?p.itemLeft||p.itemRight||!(g=f.getAdjTile([p.x,p.y],[k]))?"mugEmpty"===p.itemLeft?.name&&f.getAdjTile([p.x,p.y],v)?{type:n,item:p.itemLeft}:"mugEmpty"===p.itemRight?.name&&f.getAdjTile([p.x,p.y],v)?{type:s,item:p.itemRight}:p.itemRight&&!["sword"].includes(p.itemRight.name)&&(g=f.getAdjTile([p.x,p.y],y))&&!f.getItemAt(g[1],g[2])?{type:a,tile:g,item:p.itemRight}:p.itemLeft&&!["sword"].includes(p.itemLeft.name)&&(g=f.getAdjTile([p.x,p.y],y))&&!f.getItemAt(g[1],g[2])?{type:l,tile:g,item:p.itemLeft}:void 0:{type:r,tile:g}:{type:i,tile:g}},g=()=>{let e={x:0,y:0,scale:1,vx:0,vy:0,remv:!1,getPos:()=>[e.x,e.y],update:()=>{},draw:()=>{}};return e},p={},u={},h=e=>{let t=p[e];if(!t)throw Error("No anim: "+e);let[,i,...r]=t.split(" "),l=parseInt(i);return function([e,t,i]){let r,l,a,n,s=e||!1,o=[];o=[],r=!1,l=0,a=0,n=0,i.forEach((({n:e,d:t,offsetX:i,offsetY:r,opacity:a})=>{o.push({n:e||"",timestampBegin:l,timestampEnd:l+(t??0),d:t??0,durationUpToNow:l,offsetX:i||0,offsetY:r||0,opacity:a}),l+=t??0}));let m={reset(){r=!1,a=0,m.start()},start(){n=ue()},update(){let e=ue();if(a===o.length-1&&s&&e-n>l){let t=n+l;m.reset(),m.start(),e-t<l&&(n=t)}a=(e=>{let t=0,i=a,r=o.length-1;for(;i<=r;){let l=i+Math.floor((r-i)/2);t=l;let{timestampEnd:a,timestampBegin:s}=o[l],m=(a||0)+n;if(e<m&&e>(s||0)+n)return l;e>=m?i=l+1:r=l-1}return t})(e),s||e-n>=l&&(r=!0)},getSprite:()=>o[a]?.n};return m}([!0,e,r.map((e=>({n:e,d:l})))])},w=[12,14,27,28,29,39],y=[19,20,21,22],v=[18],T=20,A=19,x=13,k=24,b=14,L=["",'"Hey, barkeep!\nFill a mug and set it down\nhere in front of me."',"Looks like it's busy today.\nPatrons are overflowing to the side room.","In Case of Fire:\nFETCH BUCKET OF WATER\nFROM WELL OUTSIDE","We need more tables!\nOpen up the other side room!","We're attracting moles now!\nGrab a weapon when you see 'em!\nThat's why we have a weapons rack!","Business is booming!\nWe have a whole new taproom now!","A bigger tavern always\nattracts more moles.","We need to expand again!\nTheres even more space\nin the back.","Another server would be nice...","We can squeeze a few more\n in the second taproom."],_=[4,2,6,5,1,3],P=e=>_.indexOf(e)+1,S=e=>w.includes(e),E=e=>26===e,C={font:"monospace",color:"#fff",size:14,align:"center",strokeColor:"black"},M=1,D=e=>{M=e},O=(e,t,i,r,l)=>{r=r||1,l=l||$();let a="string"==typeof e?U(e):e;if(!a)throw Error(`No sprite: "${e}"`);let[n,s,o,m,d]=a;l.drawImage(n,s,o,m,d,t,i,m*r,d*r)},R=(e,t,i,r,l,a,n)=>{(n=n||$())[a?"strokeStyle":"fillStyle"]=l,n[a?"strokeRect":"fillRect"](e,t,i,r)},F=(e,t,i,r,l)=>{let{font:a,size:n,color:s,align:o,strokeColor:m}={...C,...r||{}};(l=l||$()).font=`${n}px ${a}`,l.textAlign=o,l.textBaseline="middle",m&&(l.strokeStyle=m,l.lineWidth=4,l.strokeText(e,t,i)),l.fillStyle=s,l.fillText(e,t,i)},j=null,I=null,z=null,B=e=>{let[t,i,r]=H(e.width,e.height);return i.translate(r,0),i.scale(-1,1),i.drawImage(e,0,0),t},W=e=>{let[,,,t,i]=e,[r,l]=H(t,i);return O(e,0,0,1,l),r},H=(e,t)=>{let i=document.createElement("canvas");i.width=e,i.height=t;let r=i.getContext("2d");return r.imageSmoothingEnabled=!1,[i,r,e,t]},N=()=>{if(j)return j;{let[e,t]=H(576,576);return e.id="canv",t.lineWidth=2,window.canvasDiv.appendChild(e),j=e,e}},$=()=>N().getContext("2d"),U=e=>z[e],V=(e,[t,i,r])=>S(we(e,t,r))&&-1===we(e,i,r),q=(e,t)=>{let i=[];for(let r=0;r<e**2;r++)i.push(t);return i},Y=(e,t,i)=>{let[r,l]=e,[,a,n]=t;V(e,t)&&(a[r+l*n]=i,be([r,l]).forEach((e=>{Y(e,t,i)})))},G=(e,t)=>{let i=t[1]||[],r=t[2];if(0===i.length)for(let e=0;e<r**2;e++)i.push(-1);for(let i=0;i<r**2;i++){let l=[i%r,Math.floor(i/r)];if(V(l,t))return Y(l,t,e),!0}return!1},X=(e,t,i,r)=>{let l=q(i,0),a=(r,l,n,s=!0)=>{var o;-1===we(r,e,i)&&(n.push([r[0]+r[1]*i,l]),s&&(o=t[r[0]+r[1]*i],[13,17,18,18,20,21,22].concat(w).includes(o))&&be(r,!0).forEach((e=>{a(e,l,n,!1)})))},n=[];for(let t=0;t<i;t++)for(let s=0;s<i;s++){let o=t*i+s;e[o]===r&&(l[o]=r,be([s,t],!0).forEach((e=>{a(e,r,n)})))}for(let[e,t]of n)l[e]=t;return l},K=(e,t)=>{let i=1,r=q(t,-1),l=[e,r,t];for(;G(i,l);)i++;let a=[];for(let l=1;l<i;l++)a.push(X(r,e,t,l));return a},J=()=>window.game;window.addEventListener("load",(()=>{Q()}));let Q=async()=>{Z()},Z=async()=>{await(async e=>{N();let t={},i={};await Promise.all([["sprite","res/sprite.png",16,16]].map((([e,r,l,a],n)=>new Promise((n=>{let s=new Image;s.onload=()=>{t[e]=s,((e,t,i,r,l)=>{let a=(t,i,r,l,a,n)=>{let[s,o]=H(a,n);return o.drawImage(i,r,l,a,n,0,0,a,n),e[t]=[s,0,0,a,n]},n=t.width/r,s=t.height/l;for(let e=0;e<s;e++)for(let i=0;i<n;i++){let s="s_"+(e*n+i),o=a(s,t,i*r,e*l,r,l);a(s+"_f",B(W(o)),0,0,r,l)}})(i,s,0,l,a),n()},s.src=r}))))),I=t,z=i})();let o=await(await fetch("res/map.json")).json();(()=>{let e=(e,t)=>{p[e]=t},t=[["mole",["s_9","s_10"]],["p_walk",["s_3"]],["p_wait",["s_3","s_4"]],["p2_wait",["s_5","s_6"]],["p_angry",["s_7","s_8"]],["part_+1",["s_39"]],["water",["s_40"]],["bloodf",["s_36"]],["blood",["s_35"]]];for(let[i,r]of t)e(i+"_l","t 300 "+r.join(" ")),e(i+"_r","t 300 "+r.map((e=>e+"_f")).join(" "));e("fire","t 150 s_14 s_15")})(),u.item=[,0,976,,,0,2,.15,-.4,,-547,.01,,,9.8,.1,,,.06,.03],u.itemPlace=[,0,104,,.15,.03,2,.38,,-61,,,.15,,,,,,.02,.36],u.doorOpen=[1.75,,151,.03,.01,.19,2,1.33,-9,,,,,.1,,,,.19,.01],u.doorClose=[1.24,,339,.12,.05,0,1,.42,-24,.1,,,.08,,-19,.6,,,,.79],u.step=[1.07,,309,.01,.03,.03,4,.72,,60,60,.04,,,-16,,.06,.09],u.fill=[1.09,,0,.19,,.02,,2.31,92,-25,927,,,,-1.4,.9,,.5,.09],u.moleDead=[2.1,,1360,.06,.09,.2,2,1.63,,,,,,.9,-.4,.1,.03,.57,,.01],u.moleAlert=[,,169,,.13,,2,2.18,.1,-7,,,.11,.6,,,,,.18,.05],u.plusOne=[1.12,,73,.02,.18,.06,2,.87,,,-190,.11,,,,,,.82,.01,.29],u.drawSword=[,,455,,.09,.01,2,2.31,,,-758,.01,.02,,,,,,.2,.59],u.swingSword=[,,232,.07,.02,0,4,.27,29,75,,,,.1,,,,,,.02],u.patronAngry=[1.29,,322,.03,.17,0,,.55,,-89,-843,.15,.09,.3,-234,,.02,,.09],u.dumpBucket=[1.99,,246,,.07,.03,4,.66,47,32,,,,,-.4,,.25,,.13,.83],u.hitSomething=[1.04,,772,,.07,.06,2,.31,90,-15,590,.02,,,,.3,,.47,.03],u.personHit=[,,495,.05,.19,0,3,.15,.1,,,,,,.4,,,,.03,.02],u.repair=[1.04,,610,.04,.18,.04,,.79,33,,,,,.2,85,.1,,.27],u.fire=[1.06,,1028,.11,.14,.03,4,.15,-4.8,,-690,.18,,.1,,.4,.07,.99,.15],u.destroyCrate=[,,80,.04,.03,.2,4,.34,-.3,,,,,,-9.9,,,,.18],u.levelDone=[1.04,,3,.06,.09,.09,1,.84,,14,,,,,5.2,,,.43,.13],u.levelScreen=[1.85,,123,.15,.15,.01,2,1.15,,-54,,,.26,,.3,,.06,.7,.03,.04],u.startLevel=[1.05,,0,.01,.17,.17,1,1.56,,73,225,.01,.09,,-.1,,,.43],u.gameOver=[1.7,,146,.22,.07,.18,4,2.48,,82,,,,,253,,.21,,,.01],u.timerTick=[,,1091,.18,.02,.17,4,.91,,-42,,,,,167,,,,.02];let d=+localStorage.getItem("js13k2023_tavernity_width");!isNaN(d)&&d>0&&(N().style.width=d+"px"),ee(function(o,d,g){let p=ce(o,d,g),u=ge(),h=le(),w=new ve(1e3),y=new ve(3e3),v=!1,x=!1,k="",b=0,_=0,P=document.getElementById("key-info"),S=P.children[0],E=P.children[1],C="",M=window.player=de(),D=!0,j=!1,I=!1,z=!1,B=new ve(2e3);window.addEventListener("keydown",(e=>{" "===e.key&&(D?(xe("itemPlace"),H(),V()):j?(xe("itemPlace"),U()):I?(xe("startLevel"),q()):z&&(xe("itemPlace"),Y()))}));let W=()=>J.patrons.reduce(((e,t)=>["waitForDrink","findSeat","rioting"].includes(t.getState())?e+1:e),0),H=()=>{J.setup(),D=!1},U=()=>{j=!1,v=!1,h.incLevel(),V()},V=()=>{K(),J.update(1),k=L[J.levelOrch.getTotalLevel()]??"And they just keep coming...",I=!0},q=()=>{K(),I=!1,v=!1},Y=()=>{z=!1,D=!0,J.setup()},G=e=>{for(let t=0;t<e.length;t++){let i=e[t];i.update(),i.remv&&(e.splice(t,1),t--)}},X=e=>{for(let t=0;t<e.length;t++){let i=e[t];J.room.isTileVisible(i.x,i.y)&&i.draw()}},K=()=>{J.patrons=[],J.particles=[],J.fParticles=[],J.tileOrch=pe(p,h.level);let e=h.getTotalLevel();if(0===J.items.length)for(let[e,t]of[[5,11],[5,12],[8,10],[4,15],[21,11],[21,10],[17,14],[15,3],[21,3]])J.items.push(re("mugEmpty",e,t));1===e&&J.patrons.push(oe("person",11,14)),M.x=10,M.y=12,u.start(h.level,e),J.room&&J.room.reset(h.level),M.reset(),b=0},J={cx:0,cy:0,scale:4,room:p,tileOrch:pe(p,1),levelOrch:h,items:[],patrons:[],particles:[],fParticles:[],setup(){h.reset(),J.items=[],K(),v=!1},isPaused:()=>D||j||I||z,setAdjTableOnFire(e){let t=J.getAdjTile(e,[A,T]);if(t&&15!==t[0]){let[,e,i]=t;J.room.setTileAt(e,i,15);let r=J.getItemAt(e,i);xe("fire"),r&&"mugFull"===r.name&&(r.name="mugEmpty")}},getPlayer:()=>M,getItemAt:(e,t)=>J.items.find((i=>i.x===e&&i.y===t)),getPatronAt:(e,t)=>J.patrons.find((i=>i.x===e&&i.y===t)),getAdjTile([e,t],i){for(let r of i)for(let[i,l]of be([e,t]).concat([[e,t]])){let e=J.room.getTileAt(i,l);if(e&&e[0]===r)return e}},getAdjItem([e,t]){let i,r,l=0,a=be([e,t]).concat([[e,t]]);for(let e of J.items)for(let[t,n]of a)e.x===t&&e.y===n&&(i&&i.name!==e.name||(l++,i=e,r=[t,n]));if(i&&r)return[i,l,r]},showWarning(e){E.style.opacity="1",E.innerHTML=e,B.start()},update(e){if(J.isPaused())return;u.update(),p.update(),G(J.patrons),M.update(),G(J.particles),G(J.fParticles),G(J.items);let t=N();J.cx=16*M.x*J.scale-t.width/2+8*J.scale,J.cy=16*M.y*J.scale-t.height/2+8*J.scale,h.isLevelComplete(J,u)&&!j&&(v?y.isDone()&&(v=!1,j||(S.style.opacity="0",j=!0,M.x=13,M.y=18,xe("levelScreen"),h.addCrateBonus())):(xe("levelDone"),v=!0,y.start())),W()>0&&u.lvlTimer.isDone()&&(xe("gameOver"),z=!0,S.style.opacity="0",E.style.opacity="0",_=h.getScore()[2])},draw(){let o=$();if(D)return void(()=>{w.isDone()&&(x=!x,w.start());let e=$(),{width:t,height:i}=e.canvas,r=J.scale;R(0,0,t,i,"#000");let l=(e,t,i)=>{for(let r=0;r<9;r++)i?O("s_24",e,16*r*t,t):O("s_24",16*r*t,e,t)};l(0,r),l(i-16*r,r),l(0,J.scale,!0),l(t-16*r,r,!0),S.style.opacity="0",E.style.opacity="0";for(let e=0;e<7;e++)for(let t=0;t<7;t++)O("s_11",16*r+16*t*r,16*r+16*e*r,r);O("s_17",t/2-16*r/2,i/2-16*r/2,r),O("s_18",t/2-16*r/2-16*r,i/2-16*r/2,r),O(x?"s_29":"s_30",t/2-16*r/2-16*r,i/2-16*r/2,r),O("s_18",t/2-16*r/2+16*r,i/2-16*r/2,r),O(x?"s_30":"s_29",t/2-16*r/2+16*r,i/2-16*r/2,r),F("TAVERNITY",t/2,i/2-32*r,{size:42,align:"center"}),F('"Serve me quick, barkeep,\nbefore I get angry."',t/2,i/2-16*r,{size:16,align:"center"}),F("Last Score: "+_,t/2,i/2+16*r,{size:24,align:"center"}),F("Press (SPACE) to continue.",t/2,i/2+32*r+16,{size:24,align:"center"})})();if(j)return void(()=>{let e=$(),{width:t,height:i}=e.canvas,r=J.scale;R(0,0,t,i,"#000");let[l,a,n]=h.getScore();F(`Level ${h.getTotalLevel()} Complete`,t/2,i/2-32*r,{size:42,align:"center"}),F("Round Score: "+l,t/2,i/2+12*r,{size:24,align:"center"}),F("Crate Bonus: "+a,t/2,i/2+24*r,{size:24,align:"center"}),F("Total Score: "+n,t/2,i/2+36*r,{size:24,align:"center"}),F("Press (SPACE) to start",t/2,i/2+48*r+16,{size:24,align:"center"})})();if(z)return void(()=>{let e=$(),{width:t,height:i}=e.canvas,[,,r]=h.getScore(),l=J.scale;R(0,0,t,i,"#000"),F("GAME OVER",t/2,i/2-32*l,{size:42,align:"center"}),F("Total Score: "+r,t/2,i/2+36*l,{size:24,align:"center"}),F("Press (SPACE) to start",t/2,i/2+48*l+16,{size:24,align:"center"})})();o.save(),o.translate(-J.cx,-J.cy),o.scale(J.scale,J.scale),J.room.draw(),X(J.fParticles),X(J.items),X(J.patrons),M.draw(),X(J.particles);let d=f(J);if(d){let{type:o,item:f}=d,g="";switch(o){case e:case t:g=`Pick up ${te(f.name)} (Space)`;break;case i:g="Pick up Sword (Space)";break;case r:g="Pick up Water Bucket (Space)";break;case l:case a:g=`Place ${te(f.name)} (Space)`;break;case n:case s:g="Fill Mug (Space)";break;case m:g="Put away Sword (Space)";break;case c:g="Repair (Space)"}C===g&&""!==C||(S.style.opacity=""===g?"0":"1",S.innerHTML=g,C=g)}else S.style.opacity="0",C="";B.isDone()&&(E.style.opacity="0"),o.restore(),(()=>{let e=$(),{width:t,height:i}=e.canvas,r=W();if(F("Patrons Remaining: "+(u.getRemaining()+r),16,16,{size:24,align:"left"}),F("Level: "+h.getTotalLevel(),16,i-16,{size:24,align:"left"}),v)F("Level ending soon...",t/2,64,{size:24,align:"center"});else if(!(I||u.isDone()&&0===r)){let e=Math.floor((1-u.lvlTimer.pct())*(fe+4e4)/1e3);F("Time: "+Math.floor((1-u.lvlTimer.pct())*(fe+4e4)/1e3),t-(e<=10?16:24),16,{size:e<=10?32:24,align:"right"}),b!==e&&(b=e,e<=10&&xe("timerTick"))}})(),I&&(()=>{let e=k.split("\n"),t=e.length,i=$(),{width:r,height:l}=i.canvas,a=J.scale,n=1===t?0:-(12*a+16*t)/2;R(0,l/2+n-16,r,12*t*a+16,"#000");for(let i=0;i<t;i++)F(e[i],r/2,l/2+12*i*a+16+n,{size:24,align:"center"})})()}};return window.game=J,J.setup(),J}(o.tiles,o.width,o.spawns))},ee=e=>{let t=performance.now(),i=he(22,16,30,1,2),r=()=>{(()=>{let e=N();R(0,0,e.width,e.height,"grey")})(),e.draw(),requestAnimationFrame(r)};setInterval((()=>{let r=performance.now(),l=r-t;t=r,l>4&&(l=4);let a=l;l-=a;let n=a*i/10;D(n),e.update(n)}),22),r()};window.vol=e=>{Le(.3*+e.value/100)};let te=e=>({mugEmpty:"Empty Mug",mugFull:"Full Mug",sword:"Sword",buoy:"Buoy",hammer:"Hammer",bucketFull:"Bucket"}[e]),ie=e=>(()=>{switch(e){case"mugEmpty":return"s_30";case"mugFull":return"s_29";case"sword":return"s_31";case"buoy":return"s_32";case"bucketFull":return"s_34"}})()??"s_0",re=(e,t,i)=>{let r={...g(),name:e,x:t,y:i,draw(){if(r.remv)return;let e=ie(r.name);O(e,16*r.x,16*r.y)},drawAt(e,t,i){let l=ie(r.name);O(l+(i?"_f":""),e,t)}};return r},le=()=>{let e=0,t=0,i=0,r=0,l=()=>{let e=J().room;return e.tiles.reduce(((t,i)=>17===i[0]&&e.getTileLevel(i)<=r?t+1:t),0)},a={level:1,reset(){e=0,t=0,a.level=1,i=0,r=1},incScore(){t++,e++},incLevel(){let e=a.level;0===i&&e>=2&&e<=6||a.level>6?i++:(i=0,a.level++),r++,t=0},addCrateBonus(){e+=l()},getScore:()=>[t,l(),e],getTotalLevel:()=>r,isLevelComplete:(e,t)=>t.isDone()&&!e.patrons.find((e=>"person"===e.type))};return a},ae=(e,t,i,r)=>{let l=h(e),a=new ve(t);a.start(),l.start();let n=g(),s={...n,x:i,y:r,update(){n.update(),a.isDone()&&(s.remv=!0)},draw(){l.update(),O(l.getSprite(),16*s.x,16*s.y)}};return s},ne=([e,t])=>`${e},${t}`,se=(e,t,i,r,l,a)=>{1===we(e,i,r)&&!l[ne(e)]&&(a.push({p:e,parent:t}),l[ne(e)]=!0)},oe=(e,t,i)=>{let r,l,a=g(),n=new ve("person"===e?150:300),s=new ve(1e3),o=!1,m=new ve(2e4),d=new ve(3e3),c=new ve(1e3),f=new ve(2e3),p=new ve(100),u="findSeat",w="findCrate",y={},v=e=>(y[e+="_l"]||(y[e]=h(e)),y[e]),x=e=>{if("person"===e)switch(u){case"findSeat":case"drinking":case"leaving":return v("p_walk");case"rioting":return v("p_angry");case"waitForDrink":return m.pct()<.5?v("p_wait"):v("p2_wait");case"waitForClear":case"none":return v("p_wait")}else if("mole"===e)return v("mole");return v("mole")},k=e=>{u=e,"waitForDrink"===e&&m.start(),"waitForClear"===e&&p.start(),"rioting"===e&&xe("patronAngry"),"leaving"===e&&J().tileOrch.restoreTile(C,"Table"),x("person").reset()},L=e=>{let t=J();w=e,"destroyCrate"!==e&&"destroyTable"!==e||f.start(),"findCrate"===e&&(t.tileOrch.restoreTile(C,"Crate"),t.tileOrch.isTileAvailable("Crate")||L("findTable")),"findTable"===e&&(t.tileOrch.restoreTile(C,"MoleTable"),t.tileOrch.isTileAvailable("MoleTable")||L("leaving")),"leaving"===e&&(t.tileOrch.restoreTile(C,"Crate"),t.tileOrch.restoreTile(C,"MoleTable")),x("mole").reset()},_=(e,t)=>{let i=J(),r=e.slice(1),l=((e,t,i,r)=>{let l=[],a=[{p:e}],n={[ne(e)]:!0},s=1e3;for(;a.length;){let e=a.shift();if(!e)return[];if(ye(e.p,t)){l.unshift(t);let i=e.parent;for(;i;)i.parent&&l.unshift(i.p),i=i.parent;break}for(let t of be(e.p))se(t,e,i,r,n,a);if(s--,s<=0)break}return l})(C.getPos(),r,((e,t)=>{let i=[],r=([e,i])=>t.find((t=>t.x===e&&t.y===i));for(let[t,a,n]of e.tiles)!S(l=t)&&!E(l)||r([a,n])?i.push(0):i.push(1);var l;return i})(i.room,i.patrons.concat([i.getPlayer()])),i.room.w),a=l[0];if(ye(a,C.getPos()))t();else if(a){let[e,t]=l[0],i=C.getPos();C.x=e,C.y=t,me(C,i,(e=>{let t=J();xe("doorOpen"),t.room.setTileAt(C.x,C.y,e+1)}))}else if(o){if(s.isDone()){o=!1;for(let[e,t]of be(C.getPos())){let r=i.room.getTileAt(e,t);S(r[0])&&(C.x=e,C.y=t)}}}else o=!0,s.start()},P=e=>{let t=J();if(n.isDone()){if("person"===e)switch(u){case"findSeat":{let e=t.tileOrch.getAvailTile(C,"Table");e&&_(e,(()=>{k("waitForDrink")}));break}case"leaving":{let e=t.tileOrch.getAvailTile(C,"Exit");e&&_(e,(()=>{C.remv=!0}))}}else if("mole"===e)switch(Math.random()>.9&&xe("moleAlert"),w){case"findCrate":{let e=t.tileOrch.getAvailTile(C,"Crate");e&&_(e,(()=>{L("destroyCrate")}));break}case"findTable":{let e=t.tileOrch.getAvailTile(C,"MoleTable");e&&_(e,(()=>{L("destroyTable")}));break}case"leaving":{let e=t.tileOrch.getAvailTile(C,"Exit");e&&_(e,(()=>{C.remv=!0}))}}n.start()}},C={...a,type:e,x:t,y:i,getState:()=>"person"===e?u:w,setPersonState(e){k(e)},getPos:()=>[C.x,C.y],update(){"person"===e?(()=>{let e=J();if(P("person"),"waitForDrink"===u||"rioting"===u){m.isDone()&&"rioting"!==u?(k("rioting"),c.start()):"rioting"===u&&c.isDone()&&Math.random()>.95&&(e.setAdjTableOnFire(C.getPos()),c.start());let t=e.getAdjItem(C.getPos()),i=t?.[0];"mugFull"!==i?.name||i?.remv||(i.remv=!0,r=i,l=t?.[2],k("drinking"),d.start())}else"drinking"===u?d.isDone()&&r&&l&&(k("waitForClear"),r.remv=!1,r.x=l[0],r.y=l[1],r.name="mugEmpty",e.items.push(r),r=void 0):"waitForClear"===u&&p.isDone()&&(e.room.isTileVisible(C.x,C.y)&&xe("plusOne"),e.levelOrch.incScore(),e.particles.push(ae("part_+1_l",300,C.x,C.y)),k("leaving"))})():"mole"===e&&(()=>{let e=J();if(P("mole"),"destroyCrate"===w&&f.isDone()){let t=e.getAdjTile(C.getPos(),[17]);t&&(xe("destroyCrate"),t[0]=b,L("findCrate"))}if("destroyTable"===w&&f.isDone()){let t=e.getAdjTile(C.getPos(),[A,T,21,22]);t&&(xe("destroyCrate"),t[0]=b,L("findCrate"))}})()},draw(){let t=x(e);t.update();let i=t.getSprite();O(i,16*C.x,16*C.y),"drinking"===u&&r&&r.drawAt(16*C.x+2,16*C.y+2)}};return C},me=(e,[t,i],r)=>{let l=J(),a=l.room.getTileAt(t,i)?.[0],n=l.room.getTileAt(e.x,e.y)?.[0],s=l.getPatronAt(e.x,e.y);(e=>!S(e))(n)||s&&s!==e?(E(n)&&r(n),e.x=t,e.y=i):E(a-1)&&(xe("doorClose"),l.getPatronAt(t,i)||l.room.setTileAt(t,i,a-1))},de=()=>{let p=new ve(300),u=new ve(80),h=new ve(150),w=!1,y=e=>{e.remv=!0,void 0===k.itemLeft?(xe("item"),k.itemLeft=e):void 0===k.itemRight&&(xe("item"),k.itemRight=e)},v=e=>{let t=re(e,k.x,k.y);t.remv=!0,xe("drawSword"),k.itemLeft=t,k.itemRight=t},T=(e,t)=>{let i=J(),r="item"+e,l=k[r];xe("itemPlace"),l.remv=!1,l.x=t[1],l.y=t[2],i.items.push(l),k[r]=void 0},A=e=>{xe("fill"),e.name="mugFull"},x=e=>e.reduce(((e,t)=>e||Ae(t)),!1);window.addEventListener("keydown",(g=>{let p=J();if(" "===g.key){let g=f(p);if(!g)return;let{type:u,tile:w,item:x}=g,L={[e]:()=>{y(x)},[t]:()=>{y(x)},[i]:()=>{v("sword")},[r]:()=>{v("bucketFull")},[l]:()=>{T("Left",w)},[a]:()=>{T("Right",w)},[n]:()=>{A(k.itemLeft)},[s]:()=>{A(k.itemRight)},[o]:()=>{(()=>{let e=J();if(h.isDone()){h.start(),xe("swingSword");for(let[t,i]of be([k.x,k.y])){let r=e.getPatronAt(t,i);if("rioting"===r?.getState()||"mole"===r?.type){e.room.getTileAt(t,i)[0]!==b&&e.fParticles.push(ae("bloodf_l",1/0,t,i)),e.particles.push(ae("blood_l",300,t,i)),r.remv=!0,xe("hitSomething"),setTimeout((()=>{xe("mole"===r?.type?"moleDead":"personHit")}),300);break}}}})()},[m]:()=>{k.itemLeft=k.itemRight=void 0,xe("itemPlace")},[d]:()=>{(()=>{k.itemLeft=void 0,k.itemRight=void 0,xe("dumpBucket");let e=J();for(let[t,i]of be([k.x,k.y],!0)){let[r]=e.room.getTileAt(t,i);if(15===r){e.room.setTileAt(t,i,b);for(let[r,l]of be([t,i])){let t=e.getPatronAt(r,l);"rioting"===t?.getState()&&t.setPersonState("waitForDrink")}}e.particles.push(ae("water_l",300,t,i))}})()},[c]:()=>{(e=>{let t=J(),[,i,r]=e,l=t.room.getTileAt(i,r,!0),[a]=l;e[0]=a,xe("repair")})(w)}};L[u]?.()}})),window.addEventListener("keyup",(e=>{w=!1,p.complete()}));let k=Object.assign(g(),{dir:"l",x:0,y:0,itemLeft:void 0,itemRight:void 0,ctrlEnabled:!0,reset(){},update(){(()=>{if(k.ctrlEnabled&&p.isDone()&&u.isDone()){let{x:e,y:t}=k,i=!1;x(["ArrowUp","8","7","9","Home","PageUp"])&&(k.y--,i=!0),x(["ArrowDown","2","1","3","End","PageDown"])&&(k.y++,i=!0),x(["ArrowLeft","7","4","1","Home","End"])&&(k.x--,i=!0),x(["ArrowRight","9","6","3","PageUp","PageDown"])&&(k.x++,i=!0),i&&me(k,[e,t],(e=>{let t=J();xe("doorOpen"),t.room.setTileAt(k.x,k.y,e+1),p.start(),w=!0})),k.x===e&&k.y===t||(w?u.start():(p.start(),u.start(),w=!0))}})()},draw(){let e=0;k.itemLeft&&e++,k.itemRight&&e++;let t=void 0!==k.itemLeft&&k.itemLeft===k.itemRight;if(t&&(e--,h.isDone()||e--),O("s_"+e,16*k.x,16*k.y),t){let e=-4;h.isDone()||(e=2),k.itemLeft.drawAt(16*k.x-6,16*k.y+e,!0)}else k.itemLeft&&k.itemLeft.drawAt(16*k.x-8,16*k.y-6,!0),k.itemRight&&k.itemRight.drawAt(16*k.x+8,16*k.y-6)}});return k},ce=(e,t,i=[])=>{let r=new ve(100),l=!1,a=[],n=e.map(((e,i)=>[e,i%t,Math.floor(i/t)])),s={...g(),w:t,h:t,spawns:i,visMaps:K(e,t),tiles:n,reset:e=>{let t=structuredClone(n);for(let i=0;i<t.length;i++){let r=t[i],l=s.getTileLevel(r,!0);26===r[0]&&l>e&&r[0]--}s.tiles=t},getTileAt:(e,i,r)=>(r?n:s.tiles)[i*t+e]??[0],setTileAt:(e,i,r)=>{let l=s.tiles[i*t+e];l&&(l[0]=r)},getTileLevel:(e,i)=>{let[r,l,a]=e;if(0===r)return 0;let n=0;for(let e of s.visMaps){let r=e[a*t+l];if(r){let e=P(r);if(e>n&&(n=e,!i))return n}}return n},isTileVisible:(e,i)=>a.reduce(((r,l)=>r||we([e,i],s.visMaps[l],t)>0),!1),update:()=>{a=(()=>{let e=J().getPlayer().getPos(),i=[];for(let r=0;r<s.visMaps.length;r++)we(e,s.visMaps[r],t)>0&&i.push(r);return i})(),r.isDone()&&(r.start(),l=!l)},draw:()=>{for(let e=0;e<t;e++)for(let i=0;i<t;i++){let[r]=s.tiles[i+e*t],n=s.isTileVisible(i,e,a);r&&n?(15===r&&(r+=l?1:0),O("s_"+(r-1),16*i,16*e)):R(16*i,16*e,16,16,"#000")}}};return s},fe=6e4,ge=()=>{let e=new ve(1),t=new ve(1),i=!1,r=1,l=0,a=0,n=0,s=0,o=e=>{let t,i,l=J(),a=(()=>{let e=J();return e.room.tiles.filter((t=>{for(let i of e.room.spawns)if(ye(i,t.slice(1))&&e.room.getTileLevel(t)<=r)return!0}))})(),n=ke(a);do{if(t=n[1],i=n[2],!l.getPatronAt(t,i))break;a.indexOf(n)>-1&&a.splice(a.indexOf(n),1),n=ke(a)}while(n&&a.length>0);if(!n)return!1;if("person"===e&&!l.tileOrch.isTileAvailable("Table"))return!1;let s=oe(e,t,i);return l.patrons.push(s),!0},m={lvlTimer:new ve(fe+4e4),start:(o,d)=>{i=!0,e.ms=5e3+5e3*Math.random(),e.start(),l=0,a=5+Math.floor(1.75*d),s=(()=>{switch(!0){case[5,7].includes(d):return 2;case[8,9].includes(d):return 3;case d>9:return 4;default:return 0}})(),t.ms=fe/(s+1),t.start(),n=0,r=o,m.lvlTimer.start()},stop(){i=!1},isDone:()=>l>=a,getRemaining:()=>a-l,update(){i&&(this.isDone()||(e.isDone()&&(e.ms=1+Math.random()*Math.min(7e3,(fe-5e3)*(1-m.lvlTimer.pct())/2),e.start(),o("person")&&l++),t.isDone()&&n<s&&(t.start(),o("mole")&&(xe("moleAlert"),n++))))}};return m},pe=(e,t)=>{let i=(e,t)=>t.includes(e),r=e.tiles.filter((i=>{let[r,l,a]=i;if(e.getTileLevel(i)<=t&&S(r)){let[t]=e.getTileAt(l,a-1),[i]=e.getTileAt(l-1,a),[r]=e.getTileAt(l+1,a);if(t===A||i===T||r===T)return!0}})).map((e=>[e,void 0])),l=e.tiles.filter((i=>{for(let r of e.spawns)if(ye(r,i.slice(1))&&e.getTileLevel(i)<=t)return!0})).map((e=>[e,void 0])),a=(i=[])=>e.tiles.filter((i=>{let[r,l,a]=i;if(e.getTileLevel(i)<=t&&S(r)){let[t]=e.getTileAt(l-1,a),[i]=e.getTileAt(l+1,a);if(17===t||17===i)return!0}})).map((e=>{let t=i.find((t=>t[0]===e))?.[1];return[e,t]})),n=(r=[])=>e.tiles.filter((r=>{let[l,a,n]=r;if(e.getTileLevel(r)<=t&&S(l)){let[t]=e.getTileAt(a,n+1),[r]=e.getTileAt(a,n-1),[l]=e.getTileAt(a-1,n),[s]=e.getTileAt(a+1,n);if(i(t,[T,A,21,22])||i(r,[T,21,22])||i(l,[A,21,22])||i(s,[A,21,22]))return!0}})).map((e=>{let t=r.find((t=>t[0]===e))?.[1];return[e,t]})),s=a(),o=n(),m=e=>({Table:r,Exit:l,Crate:s,MoleTable:o}[e]??[]);return{restoreTile:(e,t)=>{let i=m(t).find((t=>t[1]===e));i&&("Crate"===t&&(s=a(s)),"MoleTable"===t&&(o=n(o)),i[1]=void 0)},getAvailTile:(e,t)=>{let i=m(t).find((t=>t[1]===e));if(i)return i[0];let r=m(t).filter((e=>void 0===e[1]||"Exit"===t)),l=ke(r);return l?(l[1]=e,l[0]):void 0},isTileAvailable:e=>{let t=m(e).filter((t=>void 0===t[1]||"Exit"===e));return t?.length>0}}},ue=()=>window.performance.now(),he=(e,t,i,r,l)=>r+(e-t)*(l-r)/(i-t),we=([e,t],i,r)=>e<0||e>=r||t<0||t>=r?-1/0:i[e+t*r],ye=(e,t)=>e?.[0]===t?.[0]&&e?.[1]===t?.[1];class ve{ms;s=-999;constructor(e){this.ms=e}start(){this.s=ue()}stop(){this.s=0}pct(){let e=ue()-this.s;return e>this.ms?e=this.ms:e<0&&(e=-1),Math.min(1,e/this.ms)}complete(){this.s=-999}isDone(){return ue()-this.s>=this.ms}}let Te={};window.addEventListener("keydown",(e=>{Te[e.key]=!0;let t=N(),i=parseInt(t.style.width);isNaN(i)&&(i=t.width),"+"===e.key&&(i+=100,t.style.width=i+"px"),"-"===e.key&&(i-=100,t.style.width=i+"px"),localStorage.setItem("js13k2023_tavernity_width",i+"")})),window.addEventListener("keyup",(e=>{Te[e.key]=!1}));let Ae=e=>Te[e],xe=e=>{let t=(e=>{let t=u[e];if(!t)throw Error("No sound: "+e);return t})(e);_e(t)},ke=e=>e[Math.floor(De()*e.length)],be=([e,t],i)=>[[e-1,t],[e+1,t],[e,t-1],[e,t+1]]?.concat(i?[[e-1,t-1],[e-1,t+1],[e+1,t-1],[e+1,t+1]]:[]),Le=e=>{Se=e},_e=e=>{Pe(...e)},Pe=(...e)=>Me(Oe(...e)),Se=.1,Ee=44100,Ce=new(window.AudioContext||webkitAudioContext),Me=(...e)=>{let t=Ce.createBuffer(e.length,e[0].length,Ee),i=Ce.createBufferSource();return e.map(((e,i)=>t.getChannelData(i).set(e))),i.buffer=t,i.connect(Ce.destination),i.start(),i},De=Math.random,Oe=(e=1,t=.05,i=220,r=0,l=0,a=.1,n=0,s=1,o=0,m=0,d=0,c=0,f=0,g=0,p=0,u=0,h=0,w=1,y=0,v=0)=>{let T,A,x=2*Math.PI,k=o*=500*x/Ee/Ee,b=i*=(1+2*t*De()-t)*x/Ee,L=[],_=0,P=0,S=0,E=1,C=0,M=0,D=0;for(m*=500*x/Ee**3,p*=x/Ee,d*=x/Ee,c*=Ee,f=f*Ee|0,A=(r=r*Ee+9)+(y*=Ee)+(l*=Ee)+(a*=Ee)+(h*=Ee)|0;S<A;L[S++]=D)++M%(100*u|0)||(D=n?n>1?n>2?n>3?Math.sin((_%x)**3):Math.max(Math.min(Math.tan(_),1),-1):1-(2*_/x%2+2)%2:1-4*Math.abs(Math.round(_/x)-_/x):Math.sin(_),D=(f?1-v+v*Math.sin(x*S/f):1)*(D>0?1:-1)*Math.abs(D)**s*e*Se*(S<r?S/r:S<r+y?1-(S-r)/y*(1-w):S<r+y+l?w:S<A-h?(A-S-h)/a*w:0),D=h?D/2+(h>S?0:(S<A-h?1:(A-S)/h)*L[S-h|0]/2):D),T=(i+=o+=m)*Math.cos(p*P++),_+=T-T*g*(1-1e9*(Math.sin(S)+1)%2),E&&++E>c&&(i+=d,b+=d,E=0),!f||++C%f||(i=b,o=k,E=E||1);return L};